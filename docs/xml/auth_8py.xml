<?xml version='1.0' encoding='UTF-8' standalone='no'?>
<doxygen xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="compound.xsd" version="1.10.0" xml:lang="en-US">
  <compounddef id="auth_8py" kind="file" language="Python">
    <compoundname>auth.py</compoundname>
    <innerclass refid="classauth_1_1LoginRequest" prot="public">auth::LoginRequest</innerclass>
    <innerclass refid="classauth_1_1LoginResponse" prot="public">auth::LoginResponse</innerclass>
    <innerclass refid="classauth_1_1RefreshRequest" prot="public">auth::RefreshRequest</innerclass>
    <innerclass refid="classauth_1_1RefreshResponse" prot="public">auth::RefreshResponse</innerclass>
    <innerclass refid="classauth_1_1UserCreateRequest" prot="public">auth::UserCreateRequest</innerclass>
    <innerclass refid="classauth_1_1UserResponse" prot="public">auth::UserResponse</innerclass>
    <innerclass refid="classauth_1_1PasswordChangeRequest" prot="public">auth::PasswordChangeRequest</innerclass>
    <innerclass refid="classauth_1_1PasswordChangeResponse" prot="public">auth::PasswordChangeResponse</innerclass>
    <innerclass refid="classauth_1_1DeleteUserRequest" prot="public">auth::DeleteUserRequest</innerclass>
    <innerclass refid="classauth_1_1DeleteUserResponse" prot="public">auth::DeleteUserResponse</innerclass>
    <innernamespace refid="namespaceauth">auth</innernamespace>
    <briefdescription>
    </briefdescription>
    <detaileddescription>
    </detaileddescription>
    <programlisting>
<codeline lineno="1" refid="namespaceauth" refkind="compound"><highlight class="comment">#<sp/>Импорт<sp/>стандартных<sp/>библиотек</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2"><highlight class="normal"></highlight><highlight class="keyword">import</highlight><highlight class="normal"><sp/>binascii</highlight></codeline>
<codeline lineno="3"><highlight class="normal"></highlight><highlight class="keyword">import</highlight><highlight class="normal"><sp/>logging</highlight></codeline>
<codeline lineno="4"><highlight class="normal"></highlight><highlight class="keyword">import</highlight><highlight class="normal"><sp/>os</highlight></codeline>
<codeline lineno="5"><highlight class="normal"></highlight><highlight class="keyword">from</highlight><highlight class="normal"><sp/>datetime<sp/></highlight><highlight class="keyword">import</highlight><highlight class="normal"><sp/>datetime,<sp/>timedelta</highlight></codeline>
<codeline lineno="6"><highlight class="normal"></highlight><highlight class="keyword">from</highlight><highlight class="normal"><sp/>typing<sp/></highlight><highlight class="keyword">import</highlight><highlight class="normal"><sp/>List</highlight></codeline>
<codeline lineno="7"><highlight class="normal"></highlight></codeline>
<codeline lineno="8"><highlight class="normal"></highlight><highlight class="comment">#<sp/>Импорт<sp/>библиотек<sp/>для<sp/>работы<sp/>с<sp/>FastAPI</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="9"><highlight class="normal"></highlight><highlight class="keyword">from</highlight><highlight class="normal"><sp/>fastapi<sp/></highlight><highlight class="keyword">import</highlight><highlight class="normal"><sp/>APIRouter,<sp/>Depends,<sp/>HTTPException,<sp/>Response,<sp/>status,<sp/>WebSocket,<sp/>Request</highlight></codeline>
<codeline lineno="10"><highlight class="normal"></highlight><highlight class="keyword">from</highlight><highlight class="normal"><sp/>fastapi.responses<sp/></highlight><highlight class="keyword">import</highlight><highlight class="normal"><sp/>JSONResponse</highlight></codeline>
<codeline lineno="11"><highlight class="normal"></highlight><highlight class="keyword">from</highlight><highlight class="normal"><sp/>fastapi.security<sp/></highlight><highlight class="keyword">import</highlight><highlight class="normal"><sp/>OAuth2PasswordBearer,<sp/>OAuth2PasswordRequestForm</highlight></codeline>
<codeline lineno="12"><highlight class="normal"></highlight></codeline>
<codeline lineno="13"><highlight class="normal"></highlight><highlight class="comment">#<sp/>Импорт<sp/>библиотек<sp/>для<sp/>работы<sp/>с<sp/>переменными<sp/>окружения</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="14"><highlight class="normal"></highlight><highlight class="keyword">from</highlight><highlight class="normal"><sp/>dotenv<sp/></highlight><highlight class="keyword">import</highlight><highlight class="normal"><sp/>load_dotenv</highlight></codeline>
<codeline lineno="15"><highlight class="normal"></highlight></codeline>
<codeline lineno="16"><highlight class="normal"></highlight><highlight class="comment">#<sp/>Импорт<sp/>библиотек<sp/>для<sp/>валидации<sp/>данных</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="17"><highlight class="normal"></highlight><highlight class="keyword">from</highlight><highlight class="normal"><sp/>pydantic<sp/></highlight><highlight class="keyword">import</highlight><highlight class="normal"><sp/>BaseModel,<sp/>Field,<sp/>EmailStr,<sp/>constr</highlight></codeline>
<codeline lineno="18"><highlight class="normal"></highlight><highlight class="keyword">from</highlight><highlight class="normal"><sp/>enum<sp/></highlight><highlight class="keyword">import</highlight><highlight class="normal"><sp/>Enum</highlight></codeline>
<codeline lineno="19"><highlight class="normal"></highlight></codeline>
<codeline lineno="20"><highlight class="normal"></highlight><highlight class="comment">#<sp/>Настройка<sp/>логирования</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="21" refid="namespaceauth_1a4d6f41e6ca1555ecb54695492ed9aeab" refkind="member"><highlight class="normal">logging.basicConfig(level=logging.DEBUG)</highlight></codeline>
<codeline lineno="22" refid="namespaceauth_1a62ab3e5094f88012c1aa974d724cd41f" refkind="member"><highlight class="normal">logger<sp/>=<sp/>logging.getLogger(__name__)</highlight></codeline>
<codeline lineno="23"><highlight class="normal"></highlight></codeline>
<codeline lineno="24"><highlight class="normal"></highlight><highlight class="comment">#<sp/>Импорт<sp/>библиотек<sp/>для<sp/>работы<sp/>с<sp/>базой<sp/>данных</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="25"><highlight class="normal"></highlight><highlight class="keyword">from</highlight><highlight class="normal"><sp/>sqlalchemy.orm<sp/></highlight><highlight class="keyword">import</highlight><highlight class="normal"><sp/>Session</highlight></codeline>
<codeline lineno="26"><highlight class="normal"></highlight><highlight class="keyword">from</highlight><highlight class="normal"><sp/>sqlalchemy.exc<sp/></highlight><highlight class="keyword">import</highlight><highlight class="normal"><sp/>SQLAlchemyError</highlight></codeline>
<codeline lineno="27"><highlight class="normal"></highlight><highlight class="comment">#Импорт<sp/>лок</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="28"><highlight class="normal"></highlight><highlight class="keyword">from</highlight><highlight class="normal"><sp/>..db<sp/></highlight><highlight class="keyword">import</highlight><highlight class="normal"><sp/>User,<sp/>get_db,<sp/>init_db</highlight></codeline>
<codeline lineno="29"><highlight class="normal"></highlight><highlight class="comment">#<sp/>Импорт<sp/>реализации<sp/>хранилища<sp/>токенов<sp/>Redis</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="30"><highlight class="normal"></highlight><highlight class="keyword">from</highlight><highlight class="normal"><sp/>.redis_token_storage<sp/></highlight><highlight class="keyword">import</highlight><highlight class="normal"><sp/>RedisTokenStorage</highlight></codeline>
<codeline lineno="31"><highlight class="normal"></highlight></codeline>
<codeline lineno="32"><highlight class="normal"></highlight></codeline>
<codeline lineno="33"><highlight class="normal"></highlight><highlight class="comment">#<sp/>Загрузка<sp/>переменных<sp/>окружения</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="34"><highlight class="normal">load_dotenv()</highlight></codeline>
<codeline lineno="35"><highlight class="normal"></highlight></codeline>
<codeline lineno="36"><highlight class="normal"></highlight><highlight class="comment">#<sp/>class<sp/>RoleEnum(str,<sp/>Enum):</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="37"><highlight class="normal"></highlight><highlight class="comment">#<sp/><sp/><sp/><sp/><sp/>admin<sp/>=<sp/>&apos;admin&apos;<sp/><sp/>#<sp/>Роль<sp/>администратора,<sp/>обладающая<sp/>расширенными<sp/>правами<sp/>доступа.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="38"><highlight class="normal"></highlight><highlight class="comment">#<sp/><sp/><sp/><sp/><sp/>user<sp/>=<sp/>&apos;user&apos;<sp/><sp/>#<sp/>Обычная<sp/>пользовательская<sp/>роль<sp/>с<sp/>базовым<sp/>уровнем<sp/>доступа.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="39"><highlight class="normal"></highlight></codeline>
<codeline lineno="40"><highlight class="normal"></highlight><highlight class="comment">#<sp/>Модели<sp/>Pydantic<sp/>для<sp/>запросов<sp/>и<sp/>ответов</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="41" refid="classauth_1_1LoginRequest" refkind="compound"><highlight class="normal"></highlight><highlight class="keyword">class<sp/></highlight><highlight class="normal"><ref refid="classauth_1_1LoginRequest" kindref="compound">LoginRequest</ref>(BaseModel):</highlight></codeline>
<codeline lineno="42" refid="classauth_1_1LoginRequest_1a0e3f75a027dc97388ccfe3d12331a11b" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/>username:<sp/>str<sp/>=<sp/>Field(...,<sp/>description=</highlight><highlight class="stringliteral">&quot;Имя<sp/>пользователя<sp/>для<sp/>входа<sp/>в<sp/>систему.<sp/>Должно<sp/>быть<sp/>уникальным<sp/>и<sp/>не<sp/>повторяться<sp/>с<sp/>другими<sp/>пользователями.&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="43" refid="classauth_1_1LoginRequest_1a00b163d66ed8d5c77407465fa62b1a44" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/>password:<sp/>str<sp/>=<sp/>Field(...,<sp/>description=</highlight><highlight class="stringliteral">&quot;Пароль<sp/>пользователя.<sp/>Должен<sp/>быть<sp/>надежным<sp/>и<sp/>содержать<sp/>минимум<sp/>6<sp/>символов<sp/>для<sp/>обеспечения<sp/>безопасности.&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="44"><highlight class="normal"></highlight></codeline>
<codeline lineno="45" refid="classauth_1_1LoginResponse" refkind="compound"><highlight class="normal"></highlight><highlight class="keyword">class<sp/></highlight><highlight class="normal"><ref refid="classauth_1_1LoginResponse" kindref="compound">LoginResponse</ref>(BaseModel):</highlight></codeline>
<codeline lineno="46" refid="classauth_1_1LoginResponse_1a5592f669f1add7a37fa6ac7ae20f9a5a" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/>access_token:<sp/>str<sp/>=<sp/>Field(...,<sp/>description=</highlight><highlight class="stringliteral">&quot;Токен<sp/>доступа,<sp/>который<sp/>используется<sp/>для<sp/>аутентификации<sp/>пользователя<sp/>в<sp/>системе.&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="47" refid="classauth_1_1LoginResponse_1a8f0ebb9afaa06895f6f43136546f5144" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/>expires_in:<sp/>int<sp/>=<sp/>Field(...,<sp/>description=</highlight><highlight class="stringliteral">&quot;Время<sp/>жизни<sp/>токена<sp/>доступа<sp/>в<sp/>секундах,<sp/>после<sp/>которого<sp/>токен<sp/>становится<sp/>недействительным.&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="48" refid="classauth_1_1LoginResponse_1af5bb1bc803d0dfa5221f102b90864529" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/>expires_at:<sp/>str<sp/>=<sp/>Field(...,<sp/>description=</highlight><highlight class="stringliteral">&quot;Точная<sp/>дата<sp/>и<sp/>время<sp/>истечения<sp/>токена<sp/>доступа<sp/>в<sp/>формате<sp/>ISO<sp/>8601.&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="49" refid="classauth_1_1LoginResponse_1a57f09907080088273eb5c97eb63eec5e" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/>refresh_token:<sp/>str<sp/>=<sp/>Field(...,<sp/>description=</highlight><highlight class="stringliteral">&quot;Токен<sp/>для<sp/>обновления<sp/>доступа,<sp/>который<sp/>можно<sp/>использовать<sp/>для<sp/>получения<sp/>нового<sp/>токена<sp/>доступа<sp/>после<sp/>истечения<sp/>текущего.&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="50" refid="classauth_1_1LoginResponse_1a742f540112b817b4c5814bc9ad6873aa" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/>refresh_expires_in:<sp/>int<sp/>=<sp/>Field(...,<sp/>description=</highlight><highlight class="stringliteral">&quot;Время<sp/>жизни<sp/>токена<sp/>для<sp/>обновления<sp/>в<sp/>секундах,<sp/>после<sp/>которого<sp/>токен<sp/>становится<sp/>недействительным.&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="51" refid="classauth_1_1LoginResponse_1a64c3eb6c643b86162df46ecf1bde5d1f" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/>refresh_token_expires_at:<sp/>str<sp/>=<sp/>Field(...,<sp/>description=</highlight><highlight class="stringliteral">&quot;Точная<sp/>дата<sp/>и<sp/>время<sp/>истечения<sp/>токена<sp/>обновления<sp/>в<sp/>формате<sp/>ISO<sp/>8601.&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="52" refid="classauth_1_1LoginResponse_1a078d99d8cc7858e5e20e4f234381aa44" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/>is_admin:<sp/>bool<sp/>=<sp/>Field(...,<sp/>description=</highlight><highlight class="stringliteral">&quot;Флаг,<sp/>указывающий,<sp/>является<sp/>ли<sp/>пользователь<sp/>администратором.<sp/>True,<sp/>если<sp/>пользователь<sp/>имеет<sp/>права<sp/>администратора.&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="53"><highlight class="normal"></highlight></codeline>
<codeline lineno="54" refid="classauth_1_1RefreshRequest" refkind="compound"><highlight class="normal"></highlight><highlight class="keyword">class<sp/></highlight><highlight class="normal"><ref refid="classauth_1_1RefreshRequest" kindref="compound">RefreshRequest</ref>(BaseModel):</highlight></codeline>
<codeline lineno="55" refid="classauth_1_1RefreshRequest_1a5cd2504ad4a593a894f4b91d0971e750" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/>refresh_token:<sp/>str<sp/>=<sp/>Field(...,<sp/>description=</highlight><highlight class="stringliteral">&quot;Токен<sp/>обновления,<sp/>который<sp/>нужно<sp/>использовать<sp/>для<sp/>получения<sp/>нового<sp/>токена<sp/>доступа.&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="56"><highlight class="normal"></highlight></codeline>
<codeline lineno="57" refid="classauth_1_1RefreshResponse" refkind="compound"><highlight class="normal"></highlight><highlight class="keyword">class<sp/></highlight><highlight class="normal"><ref refid="classauth_1_1RefreshResponse" kindref="compound">RefreshResponse</ref>(BaseModel):</highlight></codeline>
<codeline lineno="58" refid="classauth_1_1RefreshResponse_1a2e0559e6e143ba074e5d97054a3320a4" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/>access_token:<sp/>str<sp/>=<sp/>Field(...,<sp/>description=</highlight><highlight class="stringliteral">&quot;Новый<sp/>токен<sp/>доступа,<sp/>выданный<sp/>пользователю.&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="59" refid="classauth_1_1RefreshResponse_1a93052658662af67f60bb7a7b5a9a4ecf" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/>expires_in:<sp/>int<sp/>=<sp/>Field(...,<sp/>description=</highlight><highlight class="stringliteral">&quot;Время<sp/>жизни<sp/>нового<sp/>токена<sp/>доступа<sp/>в<sp/>секундах.&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="60" refid="classauth_1_1RefreshResponse_1a73c28d76c73a15de38a10d204c986af2" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/>expires_at:<sp/>str<sp/>=<sp/>Field(...,<sp/>description=</highlight><highlight class="stringliteral">&quot;Время<sp/>истечения<sp/>нового<sp/>токена<sp/>доступа<sp/>в<sp/>формате<sp/>ISO<sp/>8601.&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="61" refid="classauth_1_1RefreshResponse_1aefa5cac00d633a146927da0977721f0d" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/>refresh_token:<sp/>str<sp/>=<sp/>Field(...,<sp/>description=</highlight><highlight class="stringliteral">&quot;Новый<sp/>токен<sp/>обновления,<sp/>выданный<sp/>пользователю.&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="62" refid="classauth_1_1RefreshResponse_1acfcf05c744c9f1f94f2f72d0ff7bc877" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/>refresh_expires_in:<sp/>int<sp/>=<sp/>Field(...,<sp/>description=</highlight><highlight class="stringliteral">&quot;Время<sp/>жизни<sp/>нового<sp/>токена<sp/>обновления<sp/>в<sp/>секундах.&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="63" refid="classauth_1_1RefreshResponse_1aacfc95ed22d7373509d029288086fcd9" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/>refresh_expires_at:<sp/>str<sp/>=<sp/>Field(...,<sp/>description=</highlight><highlight class="stringliteral">&quot;Время<sp/>истечения<sp/>нового<sp/>токена<sp/>обновления<sp/>в<sp/>формате<sp/>ISO<sp/>8601.&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="64"><highlight class="normal"></highlight></codeline>
<codeline lineno="65" refid="classauth_1_1UserCreateRequest" refkind="compound"><highlight class="normal"></highlight><highlight class="keyword">class<sp/></highlight><highlight class="normal"><ref refid="classauth_1_1UserCreateRequest" kindref="compound">UserCreateRequest</ref>(BaseModel):</highlight></codeline>
<codeline lineno="66" refid="classauth_1_1UserCreateRequest_1a6aef431fda013a3efd4143ffd79370cb" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/>username:<sp/>constr(min_length=3,<sp/>max_length=50)<sp/>=<sp/>Field(...,<sp/>description=</highlight><highlight class="stringliteral">&quot;Имя<sp/>пользователя.<sp/>Должно<sp/>быть<sp/>уникальным<sp/>и<sp/>содержать<sp/>от<sp/>3<sp/>до<sp/>50<sp/>символов.&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="67" refid="classauth_1_1UserCreateRequest_1a4fad3c521331dc7387067300ed513426" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/>email:<sp/>EmailStr<sp/>=<sp/>Field(...,<sp/>description=</highlight><highlight class="stringliteral">&quot;Электронная<sp/>почта<sp/>пользователя.<sp/>Должна<sp/>быть<sp/>действительной<sp/>и<sp/>уникальной.&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="68" refid="classauth_1_1UserCreateRequest_1a1bf5a4130971972b43179fddc4a8043a" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/>password:<sp/>constr(min_length=6,<sp/>max_length=50)<sp/>=<sp/>Field(...,<sp/>description=</highlight><highlight class="stringliteral">&quot;Пароль<sp/>пользователя.<sp/>Должен<sp/>быть<sp/>надежным<sp/>и<sp/>содержать<sp/>от<sp/>6<sp/>до<sp/>50<sp/>символов.&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="69" refid="classauth_1_1UserCreateRequest_1a02b081786ef492c7e5c5004e629c1474" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/>is_admin:<sp/>bool<sp/>=<sp/>Field(...,<sp/>description=</highlight><highlight class="stringliteral">&quot;Является<sp/>ли<sp/>пользователь<sp/>администратором.<sp/>True,<sp/>если<sp/>пользователь<sp/>имеет<sp/>права<sp/>администратора.&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="70"><highlight class="normal"></highlight></codeline>
<codeline lineno="71" refid="classauth_1_1UserResponse" refkind="compound"><highlight class="normal"></highlight><highlight class="keyword">class<sp/></highlight><highlight class="normal"><ref refid="classauth_1_1UserResponse" kindref="compound">UserResponse</ref>(BaseModel):</highlight></codeline>
<codeline lineno="72" refid="classauth_1_1UserResponse_1af9fd52a7408c354b99991e09b0d863e2" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/>id:<sp/>int<sp/>=<sp/>Field(...,<sp/>description=</highlight><highlight class="stringliteral">&quot;Уникальный<sp/>идентификатор<sp/>пользователя<sp/>в<sp/>системе.&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="73" refid="classauth_1_1UserResponse_1a5fec159fbf046e775dcad7c04fcd94de" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/>username:<sp/>str<sp/>=<sp/>Field(...,<sp/>description=</highlight><highlight class="stringliteral">&quot;Имя<sp/>пользователя.&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="74" refid="classauth_1_1UserResponse_1a72ba5840d1b9752c57c5ff5466eae326" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/>email:<sp/>str<sp/>=<sp/>Field(...,<sp/>description=</highlight><highlight class="stringliteral">&quot;Электронная<sp/>почта<sp/>пользователя.&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="75" refid="classauth_1_1UserResponse_1a780132dbabc283770316c7c036aab878" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/>is_admin:<sp/>bool<sp/>=<sp/>Field(...,<sp/>description=</highlight><highlight class="stringliteral">&quot;Признак<sp/>того,<sp/>является<sp/>ли<sp/>пользователь<sp/>администратором.&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="76"><highlight class="normal"></highlight></codeline>
<codeline lineno="77" refid="classauth_1_1PasswordChangeRequest" refkind="compound"><highlight class="normal"></highlight><highlight class="keyword">class<sp/></highlight><highlight class="normal"><ref refid="classauth_1_1PasswordChangeRequest" kindref="compound">PasswordChangeRequest</ref>(BaseModel):</highlight></codeline>
<codeline lineno="78" refid="classauth_1_1PasswordChangeRequest_1a7c159aa9496534e7ff01dd9ad6990115" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/>user_id:<sp/>int<sp/>=<sp/>Field(...,<sp/>description=</highlight><highlight class="stringliteral">&quot;Идентификатор<sp/>пользователя,<sp/>для<sp/>которого<sp/>нужно<sp/>изменить<sp/>пароль.&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="79" refid="classauth_1_1PasswordChangeRequest_1af2b477dc79860feb9599c65f4b203883" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/>new_password:<sp/>str<sp/>=<sp/>Field(...,<sp/>description=</highlight><highlight class="stringliteral">&quot;Новый<sp/>пароль<sp/>пользователя.<sp/>Должен<sp/>быть<sp/>надежным<sp/>и<sp/>содержать<sp/>минимум<sp/>6<sp/>символов.&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="80"><highlight class="normal"></highlight></codeline>
<codeline lineno="81" refid="classauth_1_1PasswordChangeResponse" refkind="compound"><highlight class="normal"></highlight><highlight class="keyword">class<sp/></highlight><highlight class="normal"><ref refid="classauth_1_1PasswordChangeResponse" kindref="compound">PasswordChangeResponse</ref>(BaseModel):</highlight></codeline>
<codeline lineno="82" refid="classauth_1_1PasswordChangeResponse_1a1b671df6ae3def36be8b605f1f0e6b67" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/>user_id:<sp/>int<sp/>=<sp/>Field(...,<sp/>description=</highlight><highlight class="stringliteral">&quot;Идентификатор<sp/>пользователя,<sp/>для<sp/>которого<sp/>был<sp/>изменен<sp/>пароль.&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="83" refid="classauth_1_1PasswordChangeResponse_1ac11ab832f1e396de0e0a6a46c4ce68e9" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/>message:<sp/>str<sp/>=<sp/>Field(...,<sp/>description=</highlight><highlight class="stringliteral">&quot;Сообщение<sp/>об<sp/>успешной<sp/>смене<sp/>пароля.&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="84"><highlight class="normal"></highlight></codeline>
<codeline lineno="85" refid="classauth_1_1DeleteUserRequest" refkind="compound"><highlight class="normal"></highlight><highlight class="keyword">class<sp/></highlight><highlight class="normal"><ref refid="classauth_1_1DeleteUserRequest" kindref="compound">DeleteUserRequest</ref>(BaseModel):</highlight></codeline>
<codeline lineno="86" refid="classauth_1_1DeleteUserRequest_1a2ea3332762edec7208755cf6eeb544b1" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/>user_id:<sp/>int<sp/>=<sp/>Field(...,<sp/>description=</highlight><highlight class="stringliteral">&quot;Идентификатор<sp/>пользователя,<sp/>которого<sp/>нужно<sp/>удалить.&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="87"><highlight class="normal"></highlight></codeline>
<codeline lineno="88" refid="classauth_1_1DeleteUserResponse" refkind="compound"><highlight class="normal"></highlight><highlight class="keyword">class<sp/></highlight><highlight class="normal"><ref refid="classauth_1_1DeleteUserResponse" kindref="compound">DeleteUserResponse</ref>(BaseModel):</highlight></codeline>
<codeline lineno="89" refid="classauth_1_1DeleteUserResponse_1a017b75fda57dc9bb982c006b2682697f" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/>message:<sp/>str<sp/>=<sp/>Field(...,<sp/>description=</highlight><highlight class="stringliteral">&quot;Сообщение<sp/>об<sp/>успешном<sp/>удалении<sp/>пользователя.&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="90"><highlight class="normal"></highlight></codeline>
<codeline lineno="91"><highlight class="normal"></highlight></codeline>
<codeline lineno="92"><highlight class="normal"></highlight></codeline>
<codeline lineno="93"><highlight class="normal"></highlight></codeline>
<codeline lineno="94"><highlight class="normal"></highlight></codeline>
<codeline lineno="95"><highlight class="normal"></highlight><highlight class="comment">#API<sp/>ключ</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="96"><highlight class="normal"></highlight><highlight class="comment">#api_key_header<sp/>=<sp/>APIKeyHeader(name=&quot;token&quot;,<sp/>auto_error=False)</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="97"><highlight class="normal"></highlight><highlight class="comment">#Схема<sp/>аутентификации</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="98" refid="namespaceauth_1af3c79770bc28a778b1b63717c336cd9f" refkind="member"><highlight class="normal">oauth2_scheme<sp/>=<sp/>OAuth2PasswordBearer(tokenUrl=</highlight><highlight class="stringliteral">&quot;/login&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="99"><highlight class="normal"></highlight><highlight class="comment">#Максимальное<sp/>количество<sp/>одновременных<sp/>сессий</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="100" refid="namespaceauth_1ac305efe1aa5d2925562d0017531e8994" refkind="member"><highlight class="normal">MAX_ACTIVE_TOKENS_PER_USER<sp/>=<sp/>5</highlight></codeline>
<codeline lineno="101"><highlight class="normal"></highlight></codeline>
<codeline lineno="102"><highlight class="normal"></highlight><highlight class="comment">#<sp/>Создаем<sp/>экземпляр<sp/>хранилища<sp/>токенов<sp/>Redis</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="103" refid="namespaceauth_1a17782a3fbe24b750bc69d23132af156d" refkind="member"><highlight class="normal">token_storage<sp/>=<sp/><ref refid="classredis__token__storage_1_1RedisTokenStorage" kindref="compound">RedisTokenStorage</ref>()</highlight></codeline>
<codeline lineno="104"><highlight class="normal"></highlight></codeline>
<codeline lineno="105"><highlight class="normal"></highlight><highlight class="comment">#<sp/>Создаем<sp/>экземпляр<sp/>APIRouter</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="106" refid="namespaceauth_1ac9f9e08195c81445beb8356975041a8e" refkind="member"><highlight class="normal">auth_router<sp/>=<sp/>APIRouter()</highlight></codeline>
<codeline lineno="107"><highlight class="normal"></highlight></codeline>
<codeline lineno="108"><highlight class="normal"></highlight><highlight class="comment">#<sp/>Проверка<sp/>токена</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="109" refid="namespaceauth_1a70d915b763db8a2e3530d2b9287522ca" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">async<sp/>def<sp/></highlight><highlight class="normal"><ref refid="namespaceauth_1a70d915b763db8a2e3530d2b9287522ca" kindref="member">token_required</ref>(websocket:<sp/>WebSocket,<sp/>db:<sp/>Session<sp/>=<sp/>Depends(get_db)):</highlight></codeline>
<codeline lineno="110"><highlight class="normal"><sp/><sp/><sp/><sp/>token<sp/>=<sp/>websocket.query_params.get(</highlight><highlight class="stringliteral">&apos;token&apos;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="111"><highlight class="normal"><sp/><sp/><sp/><sp/>logger.info(f</highlight><highlight class="stringliteral">&quot;Token<sp/>received<sp/>for<sp/>validation:<sp/>{token}&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="112"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>token:</highlight></codeline>
<codeline lineno="113"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>user_id<sp/>=<sp/>token_storage.retrieve_token(token)</highlight></codeline>
<codeline lineno="114"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>user_id:</highlight></codeline>
<codeline lineno="115"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>logger.info(f</highlight><highlight class="stringliteral">&quot;Token<sp/>is<sp/>valid<sp/>for<sp/>user_id:<sp/>{user_id}&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="116"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>user<sp/>=<sp/>db.query(User).filter(User.id<sp/>==<sp/>user_id).first()</highlight></codeline>
<codeline lineno="117"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>user.username<sp/></highlight><highlight class="comment">#<sp/>Token<sp/>is<sp/>valid<sp/>and<sp/>username<sp/>is<sp/>returned</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="118"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal">:</highlight></codeline>
<codeline lineno="119"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>logger.error(f</highlight><highlight class="stringliteral">&quot;Token<sp/>not<sp/>found<sp/>or<sp/>expired&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="120"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>await<sp/>websocket.close(code=status.WS_1008_POLICY_VIOLATION)</highlight></codeline>
<codeline lineno="121"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">raise</highlight><highlight class="normal"><sp/>HTTPException(status_code=401,<sp/>detail=</highlight><highlight class="stringliteral">&quot;Invalid<sp/>or<sp/>expired<sp/>token&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="122"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal">:</highlight></codeline>
<codeline lineno="123"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>logger.warning(</highlight><highlight class="stringliteral">&quot;Token<sp/>is<sp/>required<sp/>for<sp/>access&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="124"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>await<sp/>websocket.close(code=status.WS_1008_POLICY_VIOLATION)</highlight></codeline>
<codeline lineno="125"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">raise</highlight><highlight class="normal"><sp/>HTTPException(status_code=403,<sp/>detail=</highlight><highlight class="stringliteral">&apos;Token<sp/>is<sp/>required&apos;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="126"><highlight class="normal"></highlight></codeline>
<codeline lineno="127" refid="namespaceauth_1a7e51e09218962c17b300982e11efdb7c" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">async<sp/>def<sp/></highlight><highlight class="normal"><ref refid="namespaceauth_1a7e51e09218962c17b300982e11efdb7c" kindref="member">get_current_user_admin</ref>(token:<sp/>str<sp/>=<sp/>Depends(oauth2_scheme),<sp/>db:<sp/>Session<sp/>=<sp/>Depends(get_db)):</highlight></codeline>
<codeline lineno="128"><highlight class="normal"><sp/><sp/><sp/><sp/>logger.info(f</highlight><highlight class="stringliteral">&quot;Retrieving<sp/>user<sp/>details<sp/>for<sp/>token:<sp/>{token}&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="129"><highlight class="normal"><sp/><sp/><sp/><sp/>user_id<sp/>=<sp/>token_storage.retrieve_token(token)</highlight></codeline>
<codeline lineno="130"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">not</highlight><highlight class="normal"><sp/>user_id:</highlight></codeline>
<codeline lineno="131"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>logger.error(</highlight><highlight class="stringliteral">&quot;Token<sp/>not<sp/>found<sp/>or<sp/>expired&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="132"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">raise</highlight><highlight class="normal"><sp/>HTTPException(status_code=401,<sp/>detail=</highlight><highlight class="stringliteral">&quot;Invalid<sp/>or<sp/>expired<sp/>token&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="133"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">try</highlight><highlight class="normal">:</highlight></codeline>
<codeline lineno="134"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>user<sp/>=<sp/>db.query(User).filter_by(id=user_id).first()</highlight></codeline>
<codeline lineno="135"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">except</highlight><highlight class="normal"><sp/>SQLAlchemyError<sp/></highlight><highlight class="keyword">as</highlight><highlight class="normal"><sp/>e:</highlight></codeline>
<codeline lineno="136"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>logger.error(f</highlight><highlight class="stringliteral">&quot;DB<sp/>error,<sp/>failed<sp/>to<sp/>find<sp/>user:<sp/>{str(e)}&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="137"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">raise</highlight><highlight class="normal"><sp/>HTTPException(status_code=500,<sp/>detail=</highlight><highlight class="stringliteral">&quot;Internal<sp/>server<sp/>error&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="138"><highlight class="normal"></highlight></codeline>
<codeline lineno="139"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">not</highlight><highlight class="normal"><sp/>user.is_admin:</highlight></codeline>
<codeline lineno="140"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>logger.error(</highlight><highlight class="stringliteral">&quot;User<sp/>is<sp/>not<sp/>admin&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="141"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">raise</highlight><highlight class="normal"><sp/>HTTPException(status_code=403,<sp/>detail=</highlight><highlight class="stringliteral">&quot;Admin<sp/>privileges<sp/>required&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="142"><highlight class="normal"></highlight></codeline>
<codeline lineno="143"><highlight class="normal"><sp/><sp/><sp/><sp/>logger.info(f</highlight><highlight class="stringliteral">&quot;User<sp/>{user.username}<sp/>authenticated<sp/>as<sp/>admin&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="144"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>user</highlight></codeline>
<codeline lineno="145"><highlight class="normal"></highlight></codeline>
<codeline lineno="146"><highlight class="normal"></highlight><highlight class="comment">#<sp/>async<sp/>def<sp/>get_current_user_admin(request:<sp/>Request,<sp/>db:<sp/>Session<sp/>=<sp/>Depends(get_db)):</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="147"><highlight class="normal"></highlight><highlight class="comment">#<sp/><sp/><sp/><sp/><sp/>token<sp/>=<sp/>request.headers.get(&apos;token&apos;)</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="148"><highlight class="normal"></highlight><highlight class="comment">#<sp/><sp/><sp/><sp/><sp/>if<sp/>not<sp/>token:</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="149"><highlight class="normal"></highlight><highlight class="comment">#<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>raise<sp/>HTTPException(status_code=403,<sp/>detail=&quot;Token<sp/>is<sp/>required&quot;)</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="150"><highlight class="normal"></highlight></codeline>
<codeline lineno="151"><highlight class="normal"></highlight><highlight class="comment">#<sp/><sp/><sp/><sp/><sp/>user_id<sp/>=<sp/>token_storage.retrieve_user_id_by_token(token)</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="152"><highlight class="normal"></highlight><highlight class="comment">#<sp/><sp/><sp/><sp/><sp/>if<sp/>not<sp/>user_id:</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="153"><highlight class="normal"></highlight><highlight class="comment">#<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>raise<sp/>HTTPException(status_code=401,<sp/>detail=&quot;Invalid<sp/>or<sp/>expired<sp/>token&quot;)</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="154"><highlight class="normal"></highlight></codeline>
<codeline lineno="155"><highlight class="normal"></highlight><highlight class="comment">#<sp/><sp/><sp/><sp/><sp/>user<sp/>=<sp/>db.query(User).filter_by(id=user_id).first()</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="156"><highlight class="normal"></highlight><highlight class="comment">#<sp/><sp/><sp/><sp/><sp/>if<sp/>not<sp/>user<sp/>or<sp/>not<sp/>user.is_admin:</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="157"><highlight class="normal"></highlight><highlight class="comment">#<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>raise<sp/>HTTPException(status_code=403,<sp/>detail=&quot;Admin<sp/>privileges<sp/>required&quot;)</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="158"><highlight class="normal"></highlight></codeline>
<codeline lineno="159"><highlight class="normal"></highlight><highlight class="comment">#<sp/><sp/><sp/><sp/><sp/>return<sp/>user</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="160"><highlight class="normal"></highlight></codeline>
<codeline lineno="161"><highlight class="normal"></highlight><highlight class="comment">#<sp/>Функция<sp/>для<sp/>создания<sp/>токенов<sp/>доступа<sp/>и<sp/>обновления</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="162" refid="namespaceauth_1a52b18e20d7cd7aa87cddc90e819c293c" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">async<sp/>def<sp/></highlight><highlight class="normal"><ref refid="namespaceauth_1a52b18e20d7cd7aa87cddc90e819c293c" kindref="member">create_tokens</ref>(user_id):</highlight></codeline>
<codeline lineno="163"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">#<sp/>Удаляем<sp/>все<sp/>предыдущие<sp/>токены<sp/>пользователя</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="164"><highlight class="normal"><sp/><sp/><sp/><sp/>tokens<sp/>=<sp/>token_storage.retrieve_token(user_id)</highlight></codeline>
<codeline lineno="165"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>tokens:</highlight></codeline>
<codeline lineno="166"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>token<sp/></highlight><highlight class="keywordflow">in</highlight><highlight class="normal"><sp/>tokens:</highlight></codeline>
<codeline lineno="167"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>token_storage.delete_token(token[</highlight><highlight class="stringliteral">&apos;token&apos;</highlight><highlight class="normal">])</highlight></codeline>
<codeline lineno="168"><highlight class="normal"></highlight></codeline>
<codeline lineno="169"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">#<sp/>Генерируем<sp/>токен<sp/>доступа<sp/>и<sp/>токен<sp/>обновления</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="170"><highlight class="normal"><sp/><sp/><sp/><sp/>access_token<sp/>=<sp/>binascii.hexlify(os.urandom(24)).decode()</highlight></codeline>
<codeline lineno="171"><highlight class="normal"><sp/><sp/><sp/><sp/>access_token_expires_in<sp/>=<sp/>3600<sp/><sp/></highlight><highlight class="comment">#<sp/>1<sp/>час<sp/>в<sp/>секундах</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="172"><highlight class="normal"><sp/><sp/><sp/><sp/>access_token_expires_at<sp/>=<sp/>datetime.utcnow()<sp/>+<sp/>timedelta(seconds=access_token_expires_in)</highlight></codeline>
<codeline lineno="173"><highlight class="normal"><sp/><sp/><sp/><sp/>refresh_token<sp/>=<sp/>binascii.hexlify(os.urandom(24)).decode()</highlight></codeline>
<codeline lineno="174"><highlight class="normal"><sp/><sp/><sp/><sp/>refresh_token_expires_in<sp/>=<sp/>2592000<sp/><sp/></highlight><highlight class="comment">#<sp/>30<sp/>дней<sp/>в<sp/>секундах</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="175"><highlight class="normal"><sp/><sp/><sp/><sp/>refresh_token_expires_at<sp/>=<sp/>datetime.utcnow()<sp/>+<sp/>timedelta(seconds=refresh_token_expires_in)</highlight></codeline>
<codeline lineno="176"><highlight class="normal"></highlight></codeline>
<codeline lineno="177"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">#<sp/>Сохраняем<sp/>токены<sp/>в<sp/>Redis</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="178"><highlight class="normal"><sp/><sp/><sp/><sp/>token_storage.store_token(access_token,<sp/>user_id,<sp/>access_token_expires_in)</highlight></codeline>
<codeline lineno="179"><highlight class="normal"><sp/><sp/><sp/><sp/>token_storage.store_refresh_token(refresh_token,<sp/>user_id,<sp/>refresh_token_expires_in)</highlight></codeline>
<codeline lineno="180"><highlight class="normal"></highlight></codeline>
<codeline lineno="181"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="182"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&apos;token&apos;</highlight><highlight class="normal">:<sp/>access_token,</highlight></codeline>
<codeline lineno="183"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&apos;expires_in&apos;</highlight><highlight class="normal">:<sp/>access_token_expires_in,</highlight></codeline>
<codeline lineno="184"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&apos;expires_at&apos;</highlight><highlight class="normal">:<sp/>access_token_expires_at.isoformat()</highlight></codeline>
<codeline lineno="185"><highlight class="normal"><sp/><sp/><sp/><sp/>},<sp/>{</highlight></codeline>
<codeline lineno="186"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&apos;token&apos;</highlight><highlight class="normal">:<sp/>refresh_token,</highlight></codeline>
<codeline lineno="187"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&apos;expires_in&apos;</highlight><highlight class="normal">:<sp/>refresh_token_expires_in,</highlight></codeline>
<codeline lineno="188"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&apos;expires_at&apos;</highlight><highlight class="normal">:<sp/>refresh_token_expires_at.isoformat()</highlight></codeline>
<codeline lineno="189"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="190"><highlight class="normal"></highlight></codeline>
<codeline lineno="191"><highlight class="normal"></highlight><highlight class="preprocessor">@auth_router.post(&apos;/login&apos;,<sp/>response_model=LoginResponse,<sp/>summary=&quot;Авторизация<sp/>пользователя&quot;,<sp/>description=&quot;Позволяет<sp/>пользователю<sp/>войти<sp/>в<sp/>систему,<sp/>используя<sp/>имя<sp/>пользователя<sp/>и<sp/>пароль.&quot;)</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="192" refid="namespaceauth_1a70e6da45c7251d2296a1db1d56f5e359" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">async<sp/>def<sp/></highlight><highlight class="normal"><ref refid="namespaceauth_1a70e6da45c7251d2296a1db1d56f5e359" kindref="member">login</ref>(form_data:<sp/>OAuth2PasswordRequestForm<sp/>=<sp/>Depends(),<sp/>db:<sp/>Session<sp/>=<sp/>Depends(get_db)):</highlight></codeline>
<codeline lineno="193"><highlight class="normal"><sp/><sp/><sp/><sp/>username_lower<sp/>=<sp/>form_data.username.lower()<sp/><sp/></highlight><highlight class="comment">#<sp/>Преобразование<sp/>имени<sp/>пользователя<sp/>в<sp/>нижний<sp/>регистр</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="194"><highlight class="normal"><sp/><sp/><sp/><sp/>logger.debug(f</highlight><highlight class="stringliteral">&quot;Username:<sp/>{username_lower},<sp/>Password:<sp/>{form_data.password}&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="195"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">try</highlight><highlight class="normal">:</highlight></codeline>
<codeline lineno="196"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>user<sp/>=<sp/>db.query(User).filter(User.username.ilike(username_lower)).first()</highlight></codeline>
<codeline lineno="197"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>user:</highlight></codeline>
<codeline lineno="198"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>logger.debug(f</highlight><highlight class="stringliteral">&quot;Checking<sp/>password<sp/>for<sp/>user<sp/>{user.username}&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="199"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>user.check_password(form_data.password):</highlight></codeline>
<codeline lineno="200"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>logger.debug(</highlight><highlight class="stringliteral">&quot;Password<sp/>is<sp/>correct.&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="201"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">#<sp/>Создаем<sp/>новые<sp/>токены,<sp/>удаляя<sp/>старые</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="202"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>new_access_token,<sp/>new_refresh_token<sp/>=<sp/>await<sp/><ref refid="namespaceauth_1a52b18e20d7cd7aa87cddc90e819c293c" kindref="member">create_tokens</ref>(user.id)</highlight></codeline>
<codeline lineno="203"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>JSONResponse(content={</highlight></codeline>
<codeline lineno="204"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&apos;access_token&apos;</highlight><highlight class="normal">:<sp/>new_access_token[</highlight><highlight class="stringliteral">&apos;token&apos;</highlight><highlight class="normal">],</highlight></codeline>
<codeline lineno="205"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&apos;expires_in&apos;</highlight><highlight class="normal">:<sp/>new_access_token[</highlight><highlight class="stringliteral">&apos;expires_in&apos;</highlight><highlight class="normal">],<sp/><sp/></highlight><highlight class="comment">#<sp/>Время<sp/>жизни<sp/>токена<sp/>доступа<sp/>в<sp/>секундах</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="206"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&apos;expires_at&apos;</highlight><highlight class="normal">:<sp/>new_access_token[</highlight><highlight class="stringliteral">&apos;expires_at&apos;</highlight><highlight class="normal">],</highlight></codeline>
<codeline lineno="207"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&apos;refresh_token&apos;</highlight><highlight class="normal">:<sp/>new_refresh_token[</highlight><highlight class="stringliteral">&apos;token&apos;</highlight><highlight class="normal">],</highlight></codeline>
<codeline lineno="208"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&apos;refresh_expires_in&apos;</highlight><highlight class="normal">:<sp/>new_refresh_token[</highlight><highlight class="stringliteral">&apos;expires_in&apos;</highlight><highlight class="normal">],<sp/><sp/></highlight><highlight class="comment">#<sp/>Время<sp/>жизни<sp/>токена<sp/>обновления<sp/>в<sp/>секундах</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="209"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&apos;refresh_token_expires_at&apos;</highlight><highlight class="normal">:<sp/>new_refresh_token[</highlight><highlight class="stringliteral">&apos;expires_at&apos;</highlight><highlight class="normal">],</highlight></codeline>
<codeline lineno="210"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&apos;is_admin&apos;</highlight><highlight class="normal">:<sp/>user.is_admin</highlight></codeline>
<codeline lineno="211"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>},<sp/>status_code=200)</highlight></codeline>
<codeline lineno="212"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal">:</highlight></codeline>
<codeline lineno="213"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>logger.debug(</highlight><highlight class="stringliteral">&quot;Password<sp/>is<sp/>incorrect.&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="214"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>JSONResponse(content={</highlight><highlight class="stringliteral">&apos;detail&apos;</highlight><highlight class="normal">:<sp/></highlight><highlight class="stringliteral">&apos;Invalid<sp/>username<sp/>or<sp/>password&apos;</highlight><highlight class="normal">},<sp/>status_code=401)</highlight></codeline>
<codeline lineno="215"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal">:</highlight></codeline>
<codeline lineno="216"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>logger.debug(</highlight><highlight class="stringliteral">&quot;User<sp/>not<sp/>found.&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="217"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>JSONResponse(content={</highlight><highlight class="stringliteral">&apos;detail&apos;</highlight><highlight class="normal">:<sp/></highlight><highlight class="stringliteral">&apos;Invalid<sp/>username<sp/>or<sp/>password&apos;</highlight><highlight class="normal">},<sp/>status_code=401)</highlight></codeline>
<codeline lineno="218"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">except</highlight><highlight class="normal"><sp/>SQLAlchemyError<sp/></highlight><highlight class="keyword">as</highlight><highlight class="normal"><sp/>e:</highlight></codeline>
<codeline lineno="219"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>logger.error(f</highlight><highlight class="stringliteral">&quot;DB<sp/>error,<sp/>failed<sp/>to<sp/>find<sp/>user:<sp/>{str(e)}&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="220"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">raise</highlight><highlight class="normal"><sp/>HTTPException(status_code=500,<sp/>detail=</highlight><highlight class="stringliteral">&quot;Internal<sp/>server<sp/>error&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="221"><highlight class="normal"></highlight></codeline>
<codeline lineno="222"><highlight class="normal"></highlight><highlight class="preprocessor">@auth_router.post(&apos;/logout&apos;,<sp/>summary=&quot;Выход<sp/>пользователя<sp/>из<sp/>системы&quot;,<sp/>description=&quot;Позволяет<sp/>пользователю<sp/>выйти<sp/>из<sp/>системы,<sp/>удаляя<sp/>его<sp/>токены.&quot;)</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="223" refid="namespaceauth_1af95c0810d88230a4edd324a6d0c1f376" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">async<sp/>def<sp/></highlight><highlight class="normal"><ref refid="namespaceauth_1af95c0810d88230a4edd324a6d0c1f376" kindref="member">logout</ref>(request:<sp/>RefreshRequest):</highlight></codeline>
<codeline lineno="224"><highlight class="normal"><sp/><sp/><sp/><sp/>refresh_token<sp/>=<sp/>request.refresh_token</highlight></codeline>
<codeline lineno="225"><highlight class="normal"><sp/><sp/><sp/><sp/>logger.info(f</highlight><highlight class="stringliteral">&quot;Logging<sp/>out<sp/>user<sp/>with<sp/>refresh<sp/>token:<sp/>{refresh_token}&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="226"><highlight class="normal"></highlight></codeline>
<codeline lineno="227"><highlight class="normal"><sp/><sp/><sp/><sp/>user_id<sp/>=<sp/>token_storage.retrieve_user_id_by_refresh_token(refresh_token)</highlight></codeline>
<codeline lineno="228"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">not</highlight><highlight class="normal"><sp/>user_id:</highlight></codeline>
<codeline lineno="229"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>logger.error(</highlight><highlight class="stringliteral">&quot;Refresh<sp/>token<sp/>not<sp/>found<sp/>or<sp/>expired&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="230"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">raise</highlight><highlight class="normal"><sp/>HTTPException(status_code=401,<sp/>detail=</highlight><highlight class="stringliteral">&quot;Invalid<sp/>or<sp/>expired<sp/>refresh<sp/>token&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="231"><highlight class="normal"></highlight></codeline>
<codeline lineno="232"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">try</highlight><highlight class="normal">:</highlight></codeline>
<codeline lineno="233"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">#<sp/>Удаляем<sp/>все<sp/>токены<sp/>пользователя</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="234"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>token_storage.delete_tokens_by_user_id(user_id)</highlight></codeline>
<codeline lineno="235"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>token_storage.delete_all_refresh_tokens_by_user_id(user_id)</highlight></codeline>
<codeline lineno="236"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>logger.info(f</highlight><highlight class="stringliteral">&quot;User<sp/>{user_id}<sp/>logged<sp/>out<sp/>successfully&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="237"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>JSONResponse(content={</highlight><highlight class="stringliteral">&apos;detail&apos;</highlight><highlight class="normal">:<sp/></highlight><highlight class="stringliteral">&apos;Logged<sp/>out<sp/>successfully&apos;</highlight><highlight class="normal">},<sp/>status_code=200)</highlight></codeline>
<codeline lineno="238"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">except</highlight><highlight class="normal"><sp/>Exception<sp/></highlight><highlight class="keyword">as</highlight><highlight class="normal"><sp/>e:</highlight></codeline>
<codeline lineno="239"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>logger.error(f</highlight><highlight class="stringliteral">&quot;Failed<sp/>to<sp/>log<sp/>out<sp/>user:<sp/>{str(e)}&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="240"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">raise</highlight><highlight class="normal"><sp/>HTTPException(status_code=500,<sp/>detail=</highlight><highlight class="stringliteral">&quot;Internal<sp/>server<sp/>error&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="241"><highlight class="normal"></highlight></codeline>
<codeline lineno="242"><highlight class="normal"></highlight><highlight class="preprocessor">@auth_router.post(&apos;/refresh&apos;,<sp/>response_model=RefreshResponse,<sp/>summary=&quot;Обновление<sp/>токена<sp/>доступа&quot;,<sp/>description=&quot;Позволяет<sp/>обновить<sp/>токен<sp/>доступа<sp/>пользователя,<sp/>используя<sp/>действующий<sp/>токен<sp/>обновления.&quot;)</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="243" refid="namespaceauth_1a71394ac4b1319dfb9517cb819f761128" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">async<sp/>def<sp/></highlight><highlight class="normal"><ref refid="namespaceauth_1a71394ac4b1319dfb9517cb819f761128" kindref="member">refresh_token</ref>(request:<sp/>RefreshRequest,<sp/>db:<sp/>Session<sp/>=<sp/>Depends(get_db)):</highlight></codeline>
<codeline lineno="244"><highlight class="normal"><sp/><sp/><sp/><sp/>refresh_token<sp/>=<sp/>request.refresh_token</highlight></codeline>
<codeline lineno="245"><highlight class="normal"><sp/><sp/><sp/><sp/>logger.info(f</highlight><highlight class="stringliteral">&quot;Attempting<sp/>to<sp/>refresh<sp/>token<sp/>for<sp/>token:<sp/>{refresh_token}&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="246"><highlight class="normal"></highlight></codeline>
<codeline lineno="247"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">try</highlight><highlight class="normal">:</highlight></codeline>
<codeline lineno="248"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">#<sp/>Получаем<sp/>user_id<sp/>по<sp/>токену<sp/>обновления</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="249"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>user_id<sp/>=<sp/>token_storage.retrieve_user_id_by_refresh_token(refresh_token)</highlight></codeline>
<codeline lineno="250"><highlight class="normal"></highlight></codeline>
<codeline lineno="251"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">except</highlight><highlight class="normal"><sp/>UnicodeDecodeError:</highlight></codeline>
<codeline lineno="252"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>logger.error(f</highlight><highlight class="stringliteral">&quot;Redis<sp/>error,<sp/>failed<sp/>to<sp/>decode<sp/>user_id<sp/>for<sp/>refresh<sp/>token:<sp/>{refresh_token}&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="253"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">raise</highlight><highlight class="normal"><sp/>HTTPException(status_code=500,<sp/>detail=</highlight><highlight class="stringliteral">&apos;Internal<sp/>server<sp/>error<sp/>10&apos;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="254"><highlight class="normal"></highlight></codeline>
<codeline lineno="255"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">except</highlight><highlight class="normal"><sp/>Exception<sp/></highlight><highlight class="keyword">as</highlight><highlight class="normal"><sp/>e:</highlight></codeline>
<codeline lineno="256"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>logger.error(f</highlight><highlight class="stringliteral">&quot;Unexpected<sp/>error<sp/>during<sp/>token<sp/>retrieval:<sp/>{str(e)}&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="257"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">raise</highlight><highlight class="normal"><sp/>HTTPException(status_code=500,<sp/>detail=</highlight><highlight class="stringliteral">&apos;Internal<sp/>server<sp/>error<sp/>20&apos;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="258"><highlight class="normal"></highlight></codeline>
<codeline lineno="259"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">not</highlight><highlight class="normal"><sp/>user_id:</highlight></codeline>
<codeline lineno="260"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>logger.info(f</highlight><highlight class="stringliteral">&quot;Invalid<sp/>or<sp/>expired<sp/>refresh<sp/>token:<sp/>{refresh_token}&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="261"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">raise</highlight><highlight class="normal"><sp/>HTTPException(status_code=401,<sp/>detail=f</highlight><highlight class="stringliteral">&apos;Invalid<sp/>or<sp/>expired<sp/>refresh<sp/>token&apos;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="262"><highlight class="normal"></highlight></codeline>
<codeline lineno="263"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">try</highlight><highlight class="normal">:</highlight></codeline>
<codeline lineno="264"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">#<sp/>Удаляем<sp/>старый<sp/>refresh_token<sp/>перед<sp/>созданием<sp/>нового</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="265"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>token_storage.delete_refresh_token(refresh_token)</highlight></codeline>
<codeline lineno="266"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">except</highlight><highlight class="normal"><sp/>Exception<sp/></highlight><highlight class="keyword">as</highlight><highlight class="normal"><sp/>e:</highlight></codeline>
<codeline lineno="267"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>logger.error(f</highlight><highlight class="stringliteral">&quot;Error<sp/>during<sp/>refresh<sp/>token<sp/>deletion:<sp/>{str(e)}&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="268"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">raise</highlight><highlight class="normal"><sp/>HTTPException(status_code=500,<sp/>detail=</highlight><highlight class="stringliteral">&apos;Internal<sp/>server<sp/>error<sp/>30&apos;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="269"><highlight class="normal"></highlight></codeline>
<codeline lineno="270"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">try</highlight><highlight class="normal">:</highlight></codeline>
<codeline lineno="271"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>logger.info(f</highlight><highlight class="stringliteral">&quot;Refresh<sp/>token<sp/>is<sp/>valid<sp/>for<sp/>user_id:<sp/>{user_id}&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="272"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>user<sp/>=<sp/>db.query(User).filter_by(id=int(user_id)).first()</highlight></codeline>
<codeline lineno="273"><highlight class="normal"></highlight></codeline>
<codeline lineno="274"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">not</highlight><highlight class="normal"><sp/>user:</highlight></codeline>
<codeline lineno="275"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>logger.warning(f</highlight><highlight class="stringliteral">&quot;DB<sp/>error,<sp/>failed<sp/>to<sp/>find<sp/>user<sp/>for<sp/>user_id:<sp/>{user_id}&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="276"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">raise</highlight><highlight class="normal"><sp/>HTTPException(status_code=404,<sp/>detail=</highlight><highlight class="stringliteral">&apos;User<sp/>not<sp/>found&apos;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="277"><highlight class="normal"></highlight></codeline>
<codeline lineno="278"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">#<sp/>Создаем<sp/>новый<sp/>токен<sp/>доступа<sp/>и<sp/>refresh_token</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="279"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>new_access_token,<sp/>new_refresh_token<sp/>=<sp/>await<sp/><ref refid="namespaceauth_1a52b18e20d7cd7aa87cddc90e819c293c" kindref="member">create_tokens</ref>(user.id)</highlight></codeline>
<codeline lineno="280"><highlight class="normal"></highlight></codeline>
<codeline lineno="281"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>JSONResponse(content={</highlight></codeline>
<codeline lineno="282"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&apos;access_token&apos;</highlight><highlight class="normal">:<sp/>new_access_token[</highlight><highlight class="stringliteral">&apos;token&apos;</highlight><highlight class="normal">],</highlight></codeline>
<codeline lineno="283"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&apos;expires_in&apos;</highlight><highlight class="normal">:<sp/>new_access_token[</highlight><highlight class="stringliteral">&apos;expires_in&apos;</highlight><highlight class="normal">],</highlight></codeline>
<codeline lineno="284"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&apos;expires_at&apos;</highlight><highlight class="normal">:<sp/>new_access_token[</highlight><highlight class="stringliteral">&apos;expires_at&apos;</highlight><highlight class="normal">],</highlight></codeline>
<codeline lineno="285"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&apos;refresh_token&apos;</highlight><highlight class="normal">:<sp/>new_refresh_token[</highlight><highlight class="stringliteral">&apos;token&apos;</highlight><highlight class="normal">],</highlight></codeline>
<codeline lineno="286"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&apos;refresh_expires_in&apos;</highlight><highlight class="normal">:<sp/>new_refresh_token[</highlight><highlight class="stringliteral">&apos;expires_in&apos;</highlight><highlight class="normal">],</highlight></codeline>
<codeline lineno="287"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&apos;refresh_expires_at&apos;</highlight><highlight class="normal">:<sp/>new_refresh_token[</highlight><highlight class="stringliteral">&apos;expires_at&apos;</highlight><highlight class="normal">]</highlight></codeline>
<codeline lineno="288"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>},<sp/>status_code=200)</highlight></codeline>
<codeline lineno="289"><highlight class="normal"></highlight></codeline>
<codeline lineno="290"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">except</highlight><highlight class="normal"><sp/>Exception<sp/></highlight><highlight class="keyword">as</highlight><highlight class="normal"><sp/>e:</highlight></codeline>
<codeline lineno="291"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>logger.error(f</highlight><highlight class="stringliteral">&quot;Unexpected<sp/>error<sp/>while<sp/>creating<sp/>new<sp/>tokens:<sp/>{str(e)}&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="292"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">raise</highlight><highlight class="normal"><sp/>HTTPException(status_code=500,<sp/>detail=</highlight><highlight class="stringliteral">&apos;Internal<sp/>server<sp/>error<sp/>40&apos;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="293"><highlight class="normal"></highlight></codeline>
<codeline lineno="294"><highlight class="normal"></highlight></codeline>
<codeline lineno="295"><highlight class="normal"></highlight></codeline>
<codeline lineno="296"><highlight class="normal"></highlight><highlight class="preprocessor">@auth_router.post(&quot;/users/create&quot;,<sp/>response_model=UserResponse,<sp/>summary=&quot;Добавление<sp/>нового<sp/>пользователя&quot;,<sp/>description=&quot;Создает<sp/>нового<sp/>пользователя<sp/>с<sp/>указанными<sp/>данными.&quot;,<sp/>dependencies=[Depends(oauth2_scheme)</highlight><highlight class="normal">])</highlight></codeline>
<codeline lineno="297" refid="namespaceauth_1a3a0f4542a8021c943517d9ef7f7207cb" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">async<sp/>def<sp/></highlight><highlight class="normal"><ref refid="namespaceauth_1a3a0f4542a8021c943517d9ef7f7207cb" kindref="member">create_user</ref>(user_request:<sp/>UserCreateRequest,<sp/>db:<sp/>Session<sp/>=<sp/>Depends(get_db),<sp/>admin:<sp/>User<sp/>=<sp/>Depends(get_current_user_admin)):</highlight></codeline>
<codeline lineno="298"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">not</highlight><highlight class="normal"><sp/>admin.is_admin:</highlight></codeline>
<codeline lineno="299"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">raise</highlight><highlight class="normal"><sp/>HTTPException(status_code=403,<sp/>detail=</highlight><highlight class="stringliteral">&quot;Admin<sp/>privileges<sp/>required&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="300"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">try</highlight><highlight class="normal">:</highlight></codeline>
<codeline lineno="301"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>username_lower<sp/>=<sp/>user_request.username.lower()<sp/><sp/></highlight><highlight class="comment">#<sp/>Преобразование<sp/>имени<sp/>пользователя<sp/>в<sp/>нижний<sp/>регистр</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="302"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>new_user<sp/>=<sp/>User(username=username_lower,<sp/>email=user_request.email,<sp/>is_admin=user_request.is_admin)</highlight></codeline>
<codeline lineno="303"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>new_user.set_password(user_request.password)</highlight></codeline>
<codeline lineno="304"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>db.add(new_user)</highlight></codeline>
<codeline lineno="305"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>db.commit()</highlight></codeline>
<codeline lineno="306"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">except</highlight><highlight class="normal"><sp/>SQLAlchemyError<sp/></highlight><highlight class="keyword">as</highlight><highlight class="normal"><sp/>e:</highlight></codeline>
<codeline lineno="307"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>db.rollback()</highlight></codeline>
<codeline lineno="308"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>logger.error(f</highlight><highlight class="stringliteral">&quot;Failed<sp/>to<sp/>create<sp/>user:<sp/>{str(e)}&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="309"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">raise</highlight><highlight class="normal"><sp/>HTTPException(status_code=500,<sp/>detail=</highlight><highlight class="stringliteral">&quot;Internal<sp/>server<sp/>error&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="310"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>new_user</highlight></codeline>
<codeline lineno="311"><highlight class="normal"></highlight></codeline>
<codeline lineno="312"><highlight class="normal"></highlight><highlight class="preprocessor">@auth_router.delete(&quot;/users/delete&quot;,<sp/>status_code=204,<sp/>summary=&quot;Удаление<sp/>пользователя&quot;,<sp/>description=&quot;Удаляет<sp/>пользователя<sp/>по<sp/>идентификатору.&quot;,<sp/>dependencies=[Depends(oauth2_scheme)</highlight><highlight class="normal">])</highlight></codeline>
<codeline lineno="313" refid="namespaceauth_1a1255c2b2d79877783d9ac9c59b9cba0f" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">async<sp/>def<sp/></highlight><highlight class="normal"><ref refid="namespaceauth_1a1255c2b2d79877783d9ac9c59b9cba0f" kindref="member">delete_user</ref>(user_request:<sp/>DeleteUserRequest,<sp/>db:<sp/>Session<sp/>=<sp/>Depends(get_db),<sp/>admin:<sp/>User<sp/>=<sp/>Depends(get_current_user_admin)):</highlight></codeline>
<codeline lineno="314"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">not</highlight><highlight class="normal"><sp/>admin.is_admin:</highlight></codeline>
<codeline lineno="315"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">raise</highlight><highlight class="normal"><sp/>HTTPException(status_code=403,<sp/>detail=</highlight><highlight class="stringliteral">&quot;Admin<sp/>privileges<sp/>required&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="316"><highlight class="normal"><sp/><sp/><sp/><sp/>user<sp/>=<sp/>db.query(User).filter_by(id=user_request.user_id).first()</highlight></codeline>
<codeline lineno="317"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">not</highlight><highlight class="normal"><sp/>user:</highlight></codeline>
<codeline lineno="318"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">raise</highlight><highlight class="normal"><sp/>HTTPException(status_code=404,<sp/>detail=</highlight><highlight class="stringliteral">&quot;User<sp/>not<sp/>found&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="319"><highlight class="normal"></highlight></codeline>
<codeline lineno="320"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">#<sp/>Начало<sp/>транзакции</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="321"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">try</highlight><highlight class="normal">:</highlight></codeline>
<codeline lineno="322"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>tokens<sp/>=<sp/>token_storage.retrieve_token(user_request.user_id)</highlight></codeline>
<codeline lineno="323"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>tokens:</highlight></codeline>
<codeline lineno="324"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>token<sp/></highlight><highlight class="keywordflow">in</highlight><highlight class="normal"><sp/>tokens:</highlight></codeline>
<codeline lineno="325"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>token_storage.delete_token(token[</highlight><highlight class="stringliteral">&apos;token&apos;</highlight><highlight class="normal">])</highlight></codeline>
<codeline lineno="326"><highlight class="normal"></highlight></codeline>
<codeline lineno="327"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>db.delete(user)</highlight></codeline>
<codeline lineno="328"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>db.commit()</highlight></codeline>
<codeline lineno="329"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">except</highlight><highlight class="normal"><sp/>SQLAlchemyError<sp/></highlight><highlight class="keyword">as</highlight><highlight class="normal"><sp/>e:</highlight></codeline>
<codeline lineno="330"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>db.rollback()</highlight></codeline>
<codeline lineno="331"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>logger.error(f</highlight><highlight class="stringliteral">&quot;Failed<sp/>to<sp/>delete<sp/>user<sp/>{user_request.user_id}:<sp/>{str(e)}&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="332"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">raise</highlight><highlight class="normal"><sp/>HTTPException(status_code=500,<sp/>detail=</highlight><highlight class="stringliteral">&quot;Internal<sp/>server<sp/>error&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="333"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>Response(status_code=204)</highlight></codeline>
<codeline lineno="334"><highlight class="normal"></highlight></codeline>
<codeline lineno="335"><highlight class="normal"></highlight><highlight class="preprocessor">@auth_router.put(&quot;/users/password&quot;,<sp/>response_model=PasswordChangeResponse,<sp/>status_code=200,<sp/>summary=&quot;Смена<sp/>пароля<sp/>пользователя&quot;,<sp/>description=&quot;Позволяет<sp/>изменить<sp/>пароль<sp/>пользователя.&quot;,<sp/>dependencies=[Depends(oauth2_scheme)</highlight><highlight class="normal">])</highlight></codeline>
<codeline lineno="336" refid="namespaceauth_1a1c21095f56d293d884bf37f46582accc" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">async<sp/>def<sp/></highlight><highlight class="normal"><ref refid="namespaceauth_1a1c21095f56d293d884bf37f46582accc" kindref="member">change_user_password</ref>(password_request:<sp/>PasswordChangeRequest,<sp/>db:<sp/>Session<sp/>=<sp/>Depends(get_db),<sp/>admin:<sp/>User<sp/>=<sp/>Depends(get_current_user_admin)):</highlight></codeline>
<codeline lineno="337"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">not</highlight><highlight class="normal"><sp/>admin.is_admin:</highlight></codeline>
<codeline lineno="338"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">raise</highlight><highlight class="normal"><sp/>HTTPException(status_code=403,<sp/>detail=</highlight><highlight class="stringliteral">&quot;Admin<sp/>privileges<sp/>required&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="339"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">try</highlight><highlight class="normal">:</highlight></codeline>
<codeline lineno="340"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>user<sp/>=<sp/>db.query(User).filter_by(id=password_request.user_id).first()</highlight></codeline>
<codeline lineno="341"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>user:</highlight></codeline>
<codeline lineno="342"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>user.set_password(password_request.new_password)</highlight></codeline>
<codeline lineno="343"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>db.commit()</highlight></codeline>
<codeline lineno="344"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>Response(status_code=status.HTTP_200_OK,<sp/>content=</highlight><highlight class="stringliteral">&quot;Password<sp/>updated<sp/>successfully&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="345"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal">:</highlight></codeline>
<codeline lineno="346"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">raise</highlight><highlight class="normal"><sp/>HTTPException(status_code=404,<sp/>detail=</highlight><highlight class="stringliteral">&quot;User<sp/>not<sp/>found&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="347"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">except</highlight><highlight class="normal"><sp/>SQLAlchemyError<sp/></highlight><highlight class="keyword">as</highlight><highlight class="normal"><sp/>e:</highlight></codeline>
<codeline lineno="348"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>db.rollback()</highlight></codeline>
<codeline lineno="349"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>logger.error(f</highlight><highlight class="stringliteral">&quot;Failed<sp/>to<sp/>change<sp/>user<sp/>password:<sp/>{str(e)}&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="350"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">raise</highlight><highlight class="normal"><sp/>HTTPException(status_code=500,<sp/>detail=</highlight><highlight class="stringliteral">&quot;Internal<sp/>server<sp/>error&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="351"><highlight class="normal"></highlight></codeline>
<codeline lineno="352"><highlight class="normal"></highlight><highlight class="preprocessor">@auth_router.put(&quot;/users/modify&quot;,<sp/>response_model=UserResponse,<sp/>status_code=200,<sp/>summary=&quot;Изменение<sp/>пользователя&quot;,<sp/>description=&quot;Изменяет<sp/>пользователя<sp/>по<sp/>идентификатору.&quot;,<sp/>dependencies=[Depends(oauth2_scheme)</highlight><highlight class="normal">])</highlight></codeline>
<codeline lineno="353" refid="namespaceauth_1aefa7a593395931644be08041ce109591" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">async<sp/>def<sp/></highlight><highlight class="normal"><ref refid="namespaceauth_1aefa7a593395931644be08041ce109591" kindref="member">modify_user</ref>(user_request:<sp/>UserCreateRequest,<sp/>db:<sp/>Session<sp/>=<sp/>Depends(get_db),<sp/>admin:<sp/>User<sp/>=<sp/>Depends(get_current_user_admin)):</highlight></codeline>
<codeline lineno="354"><highlight class="normal"><sp/><sp/><sp/><sp/>logger.info(</highlight><highlight class="stringliteral">&quot;Полученные<sp/>данные:&quot;</highlight><highlight class="normal">,<sp/>user_request.model_dump())<sp/><sp/></highlight><highlight class="comment">#<sp/>Добавьте<sp/>эту<sp/>строку<sp/>для<sp/>отладки</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="355"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">not</highlight><highlight class="normal"><sp/>admin.is_admin:</highlight></codeline>
<codeline lineno="356"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">raise</highlight><highlight class="normal"><sp/>HTTPException(status_code=403,<sp/>detail=</highlight><highlight class="stringliteral">&quot;Admin<sp/>privileges<sp/>required&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="357"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">try</highlight><highlight class="normal">:</highlight></codeline>
<codeline lineno="358"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>user<sp/>=<sp/>db.query(User).filter_by(id=user_request.user_id).first()</highlight></codeline>
<codeline lineno="359"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>user:</highlight></codeline>
<codeline lineno="360"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>user.username<sp/>=<sp/>user_request.username</highlight></codeline>
<codeline lineno="361"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>user.email<sp/>=<sp/>user_request.email</highlight></codeline>
<codeline lineno="362"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>user.set_password(user_request.password)</highlight></codeline>
<codeline lineno="363"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>user.is_admin<sp/>=<sp/>user_request.is_admin</highlight></codeline>
<codeline lineno="364"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>db.commit()</highlight></codeline>
<codeline lineno="365"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>Response(status_code=status.HTTP_200_OK,<sp/>content=</highlight><highlight class="stringliteral">&quot;User<sp/>updated<sp/>successfully&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="366"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal">:</highlight></codeline>
<codeline lineno="367"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">raise</highlight><highlight class="normal"><sp/>HTTPException(status_code=404,<sp/>detail=</highlight><highlight class="stringliteral">&quot;User<sp/>not<sp/>found&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="368"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">except</highlight><highlight class="normal"><sp/>SQLAlchemyError<sp/></highlight><highlight class="keyword">as</highlight><highlight class="normal"><sp/>e:</highlight></codeline>
<codeline lineno="369"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>db.rollback()</highlight></codeline>
<codeline lineno="370"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>logger.error(f</highlight><highlight class="stringliteral">&quot;Failed<sp/>to<sp/>modify<sp/>user:<sp/>{str(e)}&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="371"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">raise</highlight><highlight class="normal"><sp/>HTTPException(status_code=500,<sp/>detail=</highlight><highlight class="stringliteral">&quot;Internal<sp/>server<sp/>error&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="372"><highlight class="normal"></highlight></codeline>
<codeline lineno="373"><highlight class="normal"></highlight></codeline>
<codeline lineno="374"><highlight class="normal"></highlight><highlight class="preprocessor">@auth_router.get(&quot;/users&quot;,<sp/>response_model=List[UserResponse],<sp/>summary=&quot;Получение<sp/>списка<sp/>пользователей&quot;,<sp/>description=&quot;Возвращает<sp/>список<sp/>всех<sp/>пользователей.&quot;,<sp/>dependencies=[Depends(oauth2_scheme)</highlight><highlight class="normal">])</highlight></codeline>
<codeline lineno="375" refid="namespaceauth_1a9242c3c841da8f428f532e8f827844a5" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">async<sp/>def<sp/></highlight><highlight class="normal"><ref refid="namespaceauth_1a9242c3c841da8f428f532e8f827844a5" kindref="member">get_users</ref>(db:<sp/>Session<sp/>=<sp/>Depends(get_db),<sp/>admin:<sp/>User<sp/>=<sp/>Depends(get_current_user_admin)):</highlight></codeline>
<codeline lineno="376"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">not</highlight><highlight class="normal"><sp/>admin.is_admin:</highlight></codeline>
<codeline lineno="377"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">raise</highlight><highlight class="normal"><sp/>HTTPException(status_code=403,<sp/>detail=</highlight><highlight class="stringliteral">&quot;Admin<sp/>privileges<sp/>required&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="378"><highlight class="normal"><sp/><sp/><sp/><sp/>users<sp/>=<sp/>db.query(User).all()</highlight></codeline>
<codeline lineno="379"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>users</highlight></codeline>
<codeline lineno="380"><highlight class="normal"></highlight></codeline>
<codeline lineno="381" refid="namespaceauth_1a0576ac38388513ffb14572026ff67e2a" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">def<sp/></highlight><highlight class="normal"><ref refid="namespaceauth_1a0576ac38388513ffb14572026ff67e2a" kindref="member">init_app</ref>(app):</highlight></codeline>
<codeline lineno="382"><highlight class="normal"><sp/><sp/><sp/><sp/>init_db()<sp/><sp/></highlight><highlight class="comment">#<sp/>Инициализация<sp/>базы<sp/>данных</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="383"><highlight class="normal"><sp/><sp/><sp/><sp/>app.include_router(auth_router)</highlight></codeline>
<codeline lineno="384"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>app</highlight></codeline>
    </programlisting>
    <location file="/tmp/github_repos_arch_doc_gen/yshishenya/rob/backend/auth/auth.py"/>
  </compounddef>
</doxygen>

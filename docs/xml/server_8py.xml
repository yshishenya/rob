<?xml version='1.0' encoding='UTF-8' standalone='no'?>
<doxygen xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="compound.xsd" version="1.10.0" xml:lang="en-US">
  <compounddef id="server_8py" kind="file" language="Python">
    <compoundname>server.py</compoundname>
    <innerclass refid="classbackend_1_1server_1_1ResearchRequest" prot="public">backend::server::ResearchRequest</innerclass>
    <innernamespace refid="namespacebackend">backend</innernamespace>
    <innernamespace refid="namespacebackend_1_1server">backend::server</innernamespace>
    <briefdescription>
    </briefdescription>
    <detaileddescription>
    </detaileddescription>
    <programlisting>
<codeline lineno="1" refid="namespacebackend_1_1server" refkind="compound"><highlight class="keyword">import</highlight><highlight class="normal"><sp/>json</highlight></codeline>
<codeline lineno="2"><highlight class="normal"></highlight><highlight class="keyword">import</highlight><highlight class="normal"><sp/>os</highlight></codeline>
<codeline lineno="3"><highlight class="normal"></highlight><highlight class="keyword">import</highlight><highlight class="normal"><sp/>logging</highlight></codeline>
<codeline lineno="4"><highlight class="normal"></highlight><highlight class="keyword">from</highlight><highlight class="normal"><sp/>datetime<sp/></highlight><highlight class="keyword">import</highlight><highlight class="normal"><sp/>datetime,<sp/>timezone,<sp/>timedelta</highlight></codeline>
<codeline lineno="5"><highlight class="normal"></highlight><highlight class="keyword">import</highlight><highlight class="normal"><sp/>re</highlight></codeline>
<codeline lineno="6"><highlight class="normal"></highlight></codeline>
<codeline lineno="7"><highlight class="normal"></highlight></codeline>
<codeline lineno="8"><highlight class="normal"></highlight><highlight class="keyword">from</highlight><highlight class="normal"><sp/>unidecode<sp/></highlight><highlight class="keyword">import</highlight><highlight class="normal"><sp/>unidecode</highlight></codeline>
<codeline lineno="9"><highlight class="normal"></highlight></codeline>
<codeline lineno="10"><highlight class="normal"></highlight><highlight class="comment">#<sp/>Импорты<sp/>FastAPI</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="11"><highlight class="normal"></highlight><highlight class="keyword">from</highlight><highlight class="normal"><sp/>fastapi<sp/></highlight><highlight class="keyword">import</highlight><highlight class="normal"><sp/>FastAPI,<sp/>Request,<sp/>WebSocket,<sp/>WebSocketDisconnect,<sp/>Depends</highlight></codeline>
<codeline lineno="12"><highlight class="normal"></highlight><highlight class="keyword">from</highlight><highlight class="normal"><sp/>fastapi.staticfiles<sp/></highlight><highlight class="keyword">import</highlight><highlight class="normal"><sp/>StaticFiles</highlight></codeline>
<codeline lineno="13"><highlight class="normal"></highlight><highlight class="keyword">from</highlight><highlight class="normal"><sp/>fastapi.templating<sp/></highlight><highlight class="keyword">import</highlight><highlight class="normal"><sp/>Jinja2Templates</highlight></codeline>
<codeline lineno="14"><highlight class="normal"></highlight><highlight class="keyword">from</highlight><highlight class="normal"><sp/>fastapi.middleware.cors<sp/></highlight><highlight class="keyword">import</highlight><highlight class="normal"><sp/>CORSMiddleware</highlight></codeline>
<codeline lineno="15"><highlight class="normal"></highlight></codeline>
<codeline lineno="16"><highlight class="normal"></highlight><highlight class="comment">#<sp/>Импорты<sp/>Pydantic</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="17"><highlight class="normal"></highlight><highlight class="keyword">from</highlight><highlight class="normal"><sp/>pydantic<sp/></highlight><highlight class="keyword">import</highlight><highlight class="normal"><sp/>BaseModel</highlight></codeline>
<codeline lineno="18"><highlight class="normal"></highlight></codeline>
<codeline lineno="19"><highlight class="normal"></highlight><highlight class="comment">#<sp/>Импорты<sp/>из<sp/>локальных<sp/>модулей</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="20"><highlight class="normal"></highlight><highlight class="keyword">from</highlight><highlight class="normal"><sp/><ref refid="namespacebackend_1_1websocket__manager" kindref="compound">backend.websocket_manager</ref><sp/></highlight><highlight class="keyword">import</highlight><highlight class="normal"><sp/>WebSocketManager</highlight></codeline>
<codeline lineno="21"><highlight class="normal"></highlight><highlight class="keyword">from</highlight><highlight class="normal"><sp/><ref refid="namespacebackend_1_1utils" kindref="compound">backend.utils</ref><sp/></highlight><highlight class="keyword">import</highlight><highlight class="normal"><sp/>write_md_to_pdf,<sp/>write_md_to_word,<sp/>write_text_to_md</highlight></codeline>
<codeline lineno="22"><highlight class="normal"></highlight><highlight class="keyword">from</highlight><highlight class="normal"><sp/>backend.auth.auth<sp/></highlight><highlight class="keyword">import</highlight><highlight class="normal"><sp/>auth_router,<sp/>token_required</highlight></codeline>
<codeline lineno="23"><highlight class="normal"></highlight></codeline>
<codeline lineno="24"><highlight class="normal"></highlight></codeline>
<codeline lineno="25"><highlight class="normal"></highlight><highlight class="comment">#<sp/>Настройка<sp/>уровня<sp/>логирования<sp/>для<sp/>отладки</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="26" refid="namespacebackend_1_1server_1a791304efa6d9abc2d7224777155f4ce3" refkind="member"><highlight class="normal">logging.basicConfig(level=logging.DEBUG)</highlight></codeline>
<codeline lineno="27"><highlight class="normal"></highlight></codeline>
<codeline lineno="28"><highlight class="normal"></highlight><highlight class="comment">#<sp/>Создание<sp/>экземпляра<sp/>логгера</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="29" refid="namespacebackend_1_1server_1ac7ba92e1518c9942f9b2628e59284036" refkind="member"><highlight class="normal">logger<sp/>=<sp/>logging.getLogger(__name__)</highlight></codeline>
<codeline lineno="30"><highlight class="normal"></highlight></codeline>
<codeline lineno="31"><highlight class="normal"></highlight></codeline>
<codeline lineno="32"><highlight class="normal"></highlight><highlight class="comment">#<sp/>Определение<sp/>модели<sp/>данных<sp/>для<sp/>запроса<sp/>исследования</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="33" refid="classbackend_1_1server_1_1ResearchRequest" refkind="compound"><highlight class="normal"></highlight><highlight class="keyword">class<sp/></highlight><highlight class="normal"><ref refid="classbackend_1_1server_1_1ResearchRequest" kindref="compound">ResearchRequest</ref>(BaseModel):</highlight></codeline>
<codeline lineno="34" refid="classbackend_1_1server_1_1ResearchRequest_1a67fa07b5bff295d8cf39866f3703e3cd" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/>task:<sp/>str</highlight></codeline>
<codeline lineno="35" refid="classbackend_1_1server_1_1ResearchRequest_1a19cdda16ce044d65cd3d4734ff4cb7a8" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/>report_type:<sp/>str</highlight></codeline>
<codeline lineno="36" refid="classbackend_1_1server_1_1ResearchRequest_1a312e8b781e186a3e99f6005a0b5c41ef" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/>agent:<sp/>str</highlight></codeline>
<codeline lineno="37"><highlight class="normal"></highlight></codeline>
<codeline lineno="38"><highlight class="normal"></highlight><highlight class="comment">#<sp/>Создание<sp/>экземпляра<sp/>приложения<sp/>FastAPI</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="39" refid="namespacebackend_1_1server_1a7b499ff940ba3d60a6a446047dc0e793" refkind="member"><highlight class="normal">app<sp/>=<sp/>FastAPI()</highlight></codeline>
<codeline lineno="40"><highlight class="normal"></highlight></codeline>
<codeline lineno="41"><highlight class="normal"></highlight><highlight class="comment">#<sp/>Настройка<sp/>CORS<sp/>политики<sp/>для<sp/>приложения</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="42"><highlight class="normal">app.add_middleware(</highlight></codeline>
<codeline lineno="43"><highlight class="normal"><sp/><sp/><sp/><sp/>CORSMiddleware,</highlight></codeline>
<codeline lineno="44" refid="namespacebackend_1_1server_1afd315579b9669e0ddf3c7380195c2c9f" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/>allow_origins=[</highlight><highlight class="stringliteral">&quot;*&quot;</highlight><highlight class="normal">],<sp/><sp/></highlight><highlight class="comment">#<sp/>Разрешить<sp/>все<sp/>источники</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="45" refid="namespacebackend_1_1server_1a02a6dbac09a1e44d53dac146b4b7995e" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/>allow_credentials=</highlight><highlight class="keyword">True</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="46" refid="namespacebackend_1_1server_1a31453585c4b681dd455b119aad8df27f" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/>allow_methods=[</highlight><highlight class="stringliteral">&quot;*&quot;</highlight><highlight class="normal">],<sp/><sp/></highlight><highlight class="comment">#<sp/>Разрешить<sp/>все<sp/>методы</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="47" refid="namespacebackend_1_1server_1ac0adc8d19eae0c9e8eaa11d97e60657b" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/>allow_headers=[</highlight><highlight class="stringliteral">&quot;*&quot;</highlight><highlight class="normal">],<sp/><sp/></highlight><highlight class="comment">#<sp/>Разрешить<sp/>все<sp/>заголовки</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="48"><highlight class="normal">)</highlight></codeline>
<codeline lineno="49"><highlight class="normal"></highlight></codeline>
<codeline lineno="50"><highlight class="normal"></highlight><highlight class="comment">#<sp/>Монтирование<sp/>статических<sp/>файлов<sp/>и<sp/>шаблонов</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="51" refid="namespacebackend_1_1server_1a3fb990b8f65eceb426d3046cca41f3be" refkind="member"><highlight class="normal">app.mount(</highlight><highlight class="stringliteral">&quot;/site&quot;</highlight><highlight class="normal">,<sp/>StaticFiles(directory=</highlight><highlight class="stringliteral">&quot;./frontend&quot;</highlight><highlight class="normal">),<sp/>name=</highlight><highlight class="stringliteral">&quot;site&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="52"><highlight class="normal">app.mount(</highlight><highlight class="stringliteral">&quot;/static&quot;</highlight><highlight class="normal">,<sp/>StaticFiles(directory=</highlight><highlight class="stringliteral">&quot;./frontend/static&quot;</highlight><highlight class="normal">),<sp/>name=</highlight><highlight class="stringliteral">&quot;static&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="53" refid="namespacebackend_1_1server_1a08ea44cc61f6d390978edd06e68867b2" refkind="member"><highlight class="normal">templates<sp/>=<sp/>Jinja2Templates(directory=</highlight><highlight class="stringliteral">&quot;./frontend&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="54"><highlight class="normal"></highlight></codeline>
<codeline lineno="55"><highlight class="normal"></highlight><highlight class="comment">#<sp/>Создание<sp/>менеджера<sp/>WebSocket</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="56" refid="namespacebackend_1_1server_1a967b877415aecb102a7fc379ce5041b1" refkind="member"><highlight class="normal">manager<sp/>=<sp/><ref refid="classbackend_1_1websocket__manager_1_1WebSocketManager" kindref="compound">WebSocketManager</ref>()</highlight></codeline>
<codeline lineno="57"><highlight class="normal"></highlight></codeline>
<codeline lineno="58"><highlight class="normal"></highlight></codeline>
<codeline lineno="59"><highlight class="normal"></highlight><highlight class="comment">#<sp/>Включение<sp/>маршрутизатора<sp/>аутентификации</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="60"><highlight class="normal">app.include_router(auth_router)</highlight></codeline>
<codeline lineno="61"><highlight class="normal"></highlight></codeline>
<codeline lineno="62" refid="namespacebackend_1_1server_1a9c30cd96e9e80accf2505265058bb685" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">def<sp/></highlight><highlight class="normal"><ref refid="namespacebackend_1_1server_1a9c30cd96e9e80accf2505265058bb685" kindref="member">format_filename</ref>(task):</highlight></codeline>
<codeline lineno="63"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">#<sp/>Извлечение<sp/>первой<sp/>строки</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="64"><highlight class="normal"><sp/><sp/><sp/><sp/>report_name<sp/>=<sp/>task.split(</highlight><highlight class="stringliteral">&apos;\n&apos;</highlight><highlight class="normal">,<sp/>1)[0]</highlight></codeline>
<codeline lineno="65"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">#<sp/>Удаление<sp/>спецсимволов</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="66"><highlight class="normal"><sp/><sp/><sp/><sp/>report_name<sp/>=<sp/>re.sub(</highlight><highlight class="stringliteral">r&apos;[^\w\s]&apos;</highlight><highlight class="normal">,<sp/></highlight><highlight class="stringliteral">&apos;&apos;</highlight><highlight class="normal">,<sp/>report_name)</highlight></codeline>
<codeline lineno="67"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">#<sp/>Замена<sp/>пробелов<sp/>на<sp/>подчеркивания<sp/>и<sp/>удаление<sp/>лишних<sp/>подчеркиваний</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="68"><highlight class="normal"><sp/><sp/><sp/><sp/>report_name<sp/>=<sp/>re.sub(</highlight><highlight class="stringliteral">r&apos;\s+&apos;</highlight><highlight class="normal">,<sp/></highlight><highlight class="stringliteral">&apos;_&apos;</highlight><highlight class="normal">,<sp/>report_name).strip(</highlight><highlight class="stringliteral">&apos;_&apos;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="69"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">#<sp/>Ограничение<sp/>названия<sp/>первыми<sp/>четырьмя<sp/>словами</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="70"><highlight class="normal"><sp/><sp/><sp/><sp/>report_name<sp/>=<sp/></highlight><highlight class="stringliteral">&apos;_&apos;</highlight><highlight class="normal">.join(report_name.split(</highlight><highlight class="stringliteral">&apos;_&apos;</highlight><highlight class="normal">)[:5])</highlight></codeline>
<codeline lineno="71"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">#<sp/>Транслитерация<sp/>с<sp/>использованием<sp/>unidecode</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="72"><highlight class="normal"><sp/><sp/><sp/><sp/>report_name_translit<sp/>=<sp/>unidecode(report_name)</highlight></codeline>
<codeline lineno="73"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">#<sp/>Добавление<sp/>даты<sp/>и<sp/>уникального<sp/>идентификатора</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="74"><highlight class="normal"><sp/><sp/><sp/><sp/>current_date<sp/>=<sp/>datetime.now().strftime(</highlight><highlight class="stringliteral">&quot;%Y-%m-%d&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="75"><highlight class="normal"><sp/><sp/><sp/><sp/>current_time_ms<sp/>=<sp/>datetime.now().strftime(</highlight><highlight class="stringliteral">&quot;%H-%M-%S-%f&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="76"><highlight class="normal"><sp/><sp/><sp/><sp/>unique_folder_path<sp/>=<sp/>f</highlight><highlight class="stringliteral">&quot;outputs/{current_date}_{report_name_translit}_{current_time_ms}&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="77"><highlight class="normal"><sp/><sp/><sp/><sp/>os.makedirs(unique_folder_path,<sp/>exist_ok=</highlight><highlight class="keyword">True</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="78"><highlight class="normal"><sp/><sp/><sp/><sp/>file_path<sp/>=<sp/>f</highlight><highlight class="stringliteral">&quot;{unique_folder_path}/{report_name_translit}&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="79"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>file_path</highlight></codeline>
<codeline lineno="80"><highlight class="normal"></highlight></codeline>
<codeline lineno="81"><highlight class="normal"></highlight><highlight class="comment">#<sp/>Dynamic<sp/>directory<sp/>for<sp/>outputs<sp/>once<sp/>first<sp/>research<sp/>is<sp/>run</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="82"><highlight class="normal"></highlight><highlight class="preprocessor">@app.on_event(&quot;startup&quot;)</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="83" refid="namespacebackend_1_1server_1aa20a85ade2f14a7b9746f098733052a9" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">def<sp/></highlight><highlight class="normal"><ref refid="namespacebackend_1_1server_1aa20a85ade2f14a7b9746f098733052a9" kindref="member">startup_event</ref>():</highlight></codeline>
<codeline lineno="84"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">not</highlight><highlight class="normal"><sp/>os.path.isdir(</highlight><highlight class="stringliteral">&quot;outputs&quot;</highlight><highlight class="normal">):</highlight></codeline>
<codeline lineno="85"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>os.makedirs(</highlight><highlight class="stringliteral">&quot;outputs&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="86"><highlight class="normal"><sp/><sp/><sp/><sp/>app.mount(</highlight><highlight class="stringliteral">&quot;/outputs&quot;</highlight><highlight class="normal">,<sp/>StaticFiles(directory=</highlight><highlight class="stringliteral">&quot;outputs&quot;</highlight><highlight class="normal">),<sp/>name=</highlight><highlight class="stringliteral">&quot;outputs&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="87"><highlight class="normal"></highlight></codeline>
<codeline lineno="88"><highlight class="normal"></highlight><highlight class="preprocessor">@app.get(&quot;/&quot;)</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="89" refid="namespacebackend_1_1server_1aaf74caa59bfb354fc9376ff64b5b0450" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">async<sp/>def<sp/></highlight><highlight class="normal"><ref refid="namespacebackend_1_1server_1aaf74caa59bfb354fc9376ff64b5b0450" kindref="member">read_root</ref>(request:<sp/>Request):</highlight></codeline>
<codeline lineno="90"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>templates.TemplateResponse(</highlight><highlight class="stringliteral">&apos;index.html&apos;</highlight><highlight class="normal">,<sp/>{</highlight><highlight class="stringliteral">&quot;request&quot;</highlight><highlight class="normal">:<sp/>request,<sp/></highlight><highlight class="stringliteral">&quot;report&quot;</highlight><highlight class="normal">:<sp/></highlight><highlight class="keywordtype">None</highlight><highlight class="normal">})</highlight></codeline>
<codeline lineno="91"><highlight class="normal"></highlight></codeline>
<codeline lineno="92" refid="namespacebackend_1_1server_1ad4dad2e900f405ce89832734ae7a4b80" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">def<sp/></highlight><highlight class="normal"><ref refid="namespacebackend_1_1server_1ad4dad2e900f405ce89832734ae7a4b80" kindref="member">save_request_to_file</ref>(data,<sp/>username):</highlight></codeline>
<codeline lineno="93"><highlight class="normal"><sp/><sp/><sp/><sp/>moscow_time<sp/>=<sp/>datetime.now(timezone(timedelta(hours=3)))<sp/><sp/></highlight><highlight class="comment">#<sp/>Московское<sp/>время<sp/>UTC+3</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="94"><highlight class="normal"><sp/><sp/><sp/><sp/>timestamp<sp/>=<sp/>moscow_time.strftime(</highlight><highlight class="stringliteral">&quot;%Y-%m-%d<sp/>%H:%M:%S&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="95"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">with</highlight><highlight class="normal"><sp/>open(</highlight><highlight class="stringliteral">&quot;user_requests.txt&quot;</highlight><highlight class="normal">,<sp/></highlight><highlight class="stringliteral">&quot;a&quot;</highlight><highlight class="normal">)<sp/></highlight><highlight class="keyword">as</highlight><highlight class="normal"><sp/>file:</highlight></codeline>
<codeline lineno="96"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>file.write(f</highlight><highlight class="stringliteral">&quot;{timestamp}<sp/>МСК<sp/>-<sp/>User:{username}<sp/>-<sp/>Request:{data}\n&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="97"><highlight class="normal"></highlight></codeline>
<codeline lineno="98"><highlight class="normal"></highlight><highlight class="comment">#<sp/>Определение<sp/>WebSocket<sp/>эндпоинта</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="99"><highlight class="normal"></highlight><highlight class="preprocessor">@app.websocket(&quot;/ws&quot;)</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="100" refid="namespacebackend_1_1server_1add4a342eaeb04b916c8e3ca8ee280129" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">async<sp/>def<sp/></highlight><highlight class="normal"><ref refid="namespacebackend_1_1server_1add4a342eaeb04b916c8e3ca8ee280129" kindref="member">websocket_endpoint</ref>(websocket:<sp/>WebSocket,<sp/>username:<sp/>str<sp/>=<sp/>Depends(token_required)):</highlight></codeline>
<codeline lineno="101"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">try</highlight><highlight class="normal">:</highlight></codeline>
<codeline lineno="102"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>logger.debug(</highlight><highlight class="stringliteral">&quot;Attempting<sp/>to<sp/>connect<sp/>to<sp/>WebSocket.&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="103"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>await<sp/>websocket.accept()</highlight></codeline>
<codeline lineno="104"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>logger.debug(</highlight><highlight class="stringliteral">&quot;WebSocket<sp/>connection<sp/>accepted.&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="105"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">except</highlight><highlight class="normal"><sp/>Exception<sp/></highlight><highlight class="keyword">as</highlight><highlight class="normal"><sp/>e:</highlight></codeline>
<codeline lineno="106"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>logger.error(f</highlight><highlight class="stringliteral">&quot;Error<sp/>in<sp/>websocket_endpoint:<sp/>{e}&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="107"><highlight class="normal"></highlight></codeline>
<codeline lineno="108"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">#<sp/>Обработка<sp/>сообщений<sp/>WebSocket</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="109"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">try</highlight><highlight class="normal">:</highlight></codeline>
<codeline lineno="110"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">True</highlight><highlight class="normal">:</highlight></codeline>
<codeline lineno="111"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>data<sp/>=<sp/>await<sp/>websocket.receive_text()</highlight></codeline>
<codeline lineno="112"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="namespacebackend_1_1server_1ad4dad2e900f405ce89832734ae7a4b80" kindref="member">save_request_to_file</ref>(data,<sp/>username)<sp/><sp/></highlight><highlight class="comment">#<sp/>Сохраняем<sp/>текст<sp/>запроса</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="113"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>data.startswith(</highlight><highlight class="stringliteral">&quot;start&quot;</highlight><highlight class="normal">):</highlight></codeline>
<codeline lineno="114"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">try</highlight><highlight class="normal">:</highlight></codeline>
<codeline lineno="115"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>json_data<sp/>=<sp/>json.loads(data[6:])</highlight></codeline>
<codeline lineno="116"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>task<sp/>=<sp/>json_data.get(</highlight><highlight class="stringliteral">&quot;task&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="117"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>report_type<sp/>=<sp/>json_data.get(</highlight><highlight class="stringliteral">&quot;report_type&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="118"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>file_path<sp/>=<sp/><ref refid="namespacebackend_1_1server_1a9c30cd96e9e80accf2505265058bb685" kindref="member">format_filename</ref>(task)</highlight></codeline>
<codeline lineno="119"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>report_source<sp/>=<sp/>json_data.get(</highlight><highlight class="stringliteral">&quot;report_source&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="120"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>task<sp/></highlight><highlight class="keywordflow">and</highlight><highlight class="normal"><sp/>report_type:</highlight></codeline>
<codeline lineno="121"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>report<sp/>=<sp/>await<sp/>manager.start_streaming(task,<sp/>report_type,<sp/>report_source,<sp/>websocket)</highlight></codeline>
<codeline lineno="122"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">#<sp/>Сохранение<sp/>отчета<sp/>в<sp/>формате<sp/>MD</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="123"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>md_path<sp/>=<sp/>await<sp/>write_text_to_md(report,<sp/>file_path)</highlight></codeline>
<codeline lineno="124"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">#<sp/>Сохранение<sp/>отчета<sp/>в<sp/>формате<sp/>PDF</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="125"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pdf_path<sp/>=<sp/>await<sp/>write_md_to_pdf(report,<sp/>file_path)</highlight></codeline>
<codeline lineno="126"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">#<sp/>Сохранение<sp/>отчета<sp/>в<sp/>формате<sp/>DOCX</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="127"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>docx_path<sp/>=<sp/>await<sp/>write_md_to_word(report,<sp/>file_path)</highlight></codeline>
<codeline lineno="128"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">#<sp/>Возврат<sp/>путей<sp/>к<sp/>сохраненным<sp/>файлам<sp/>отчетов</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="129"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>await<sp/>websocket.send_json({</highlight><highlight class="stringliteral">&quot;type&quot;</highlight><highlight class="normal">:<sp/></highlight><highlight class="stringliteral">&quot;path&quot;</highlight><highlight class="normal">,<sp/></highlight><highlight class="stringliteral">&quot;output&quot;</highlight><highlight class="normal">:<sp/>{</highlight><highlight class="stringliteral">&quot;pdf&quot;</highlight><highlight class="normal">:<sp/>pdf_path,<sp/></highlight><highlight class="stringliteral">&quot;docx&quot;</highlight><highlight class="normal">:<sp/>docx_path,<sp/></highlight><highlight class="stringliteral">&quot;md&quot;</highlight><highlight class="normal">:<sp/>md_path}})</highlight></codeline>
<codeline lineno="130"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal">:</highlight></codeline>
<codeline lineno="131"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>await<sp/>websocket.send_text(</highlight><highlight class="stringliteral">&quot;Error:<sp/>not<sp/>enough<sp/>parameters<sp/>provided.&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="132"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">except</highlight><highlight class="normal"><sp/>json.JSONDecodeError:</highlight></codeline>
<codeline lineno="133"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>await<sp/>websocket.send_text(</highlight><highlight class="stringliteral">&quot;Error:<sp/>Failed<sp/>to<sp/>parse<sp/>JSON.&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="134"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">except</highlight><highlight class="normal"><sp/>Exception<sp/></highlight><highlight class="keyword">as</highlight><highlight class="normal"><sp/>e:</highlight></codeline>
<codeline lineno="135"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>logger.error(f</highlight><highlight class="stringliteral">&quot;Error<sp/>during<sp/>report<sp/>generation<sp/>or<sp/>saving:<sp/>{e}&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="136"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>await<sp/>websocket.send_text(</highlight><highlight class="stringliteral">&quot;Error:<sp/>Failed<sp/>to<sp/>process<sp/>the<sp/>request.&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="137"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">except</highlight><highlight class="normal"><sp/>WebSocketDisconnect:</highlight></codeline>
<codeline lineno="138"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>await<sp/>manager.disconnect(websocket)</highlight></codeline>
<codeline lineno="139"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">except</highlight><highlight class="normal"><sp/>Exception<sp/></highlight><highlight class="keyword">as</highlight><highlight class="normal"><sp/>e:</highlight></codeline>
<codeline lineno="140"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>logger.error(f</highlight><highlight class="stringliteral">&quot;Unhandled<sp/>error<sp/>in<sp/>websocket_endpoint:<sp/>{e}&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="141"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>await<sp/>websocket.close(code=1011)<sp/><sp/></highlight><highlight class="comment">#<sp/>Неожиданное<sp/>условие,<sp/>которое<sp/>помешало<sp/>выполнить<sp/>запрос</highlight><highlight class="normal"></highlight></codeline>
    </programlisting>
    <location file="/tmp/github_repos_arch_doc_gen/yshishenya/rob/backend/server.py"/>
  </compounddef>
</doxygen>

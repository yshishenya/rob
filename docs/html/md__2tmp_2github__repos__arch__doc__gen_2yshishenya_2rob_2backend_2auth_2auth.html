<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.10.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<!-- BEGIN opengraph metadata -->
<meta property="og:title" content="Doxygen Awesome" />
<meta property="og:image" content="https://repository-images.githubusercontent.com/348492097/4f16df80-88fb-11eb-9d31-4015ff22c452" />
<meta property="og:description" content="Custom CSS theme for doxygen html-documentation with lots of customization parameters." />
<meta property="og:url" content="https://jothepro.github.io/doxygen-awesome-css/" />
<!-- END opengraph metadata -->
<!-- BEGIN twitter metadata -->
<meta name="twitter:image:src" content="https://repository-images.githubusercontent.com/348492097/4f16df80-88fb-11eb-9d31-4015ff22c452" />
<meta name="twitter:title" content="Doxygen Awesome" />
<meta name="twitter:description" content="Custom CSS theme for doxygen html-documentation with lots of customization parameters." />
<!-- END twitter metadata -->
<title>rob: auth</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link rel="icon" type="image/svg+xml" href="logo.drawio.svg"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="doxygen-awesome-darkmode-toggle.js"></script>
<script type="text/javascript" src="doxygen-awesome-fragment-copy-button.js"></script>
<script type="text/javascript" src="doxygen-awesome-paragraph-link.js"></script>
<script type="text/javascript" src="doxygen-awesome-interactive-toc.js"></script>
<script type="text/javascript" src="doxygen-awesome-tabs.js"></script>
<script type="text/javascript" src="toggle-alternative-theme.js"></script>
<script type="text/javascript">
    DoxygenAwesomeFragmentCopyButton.init()
    DoxygenAwesomeDarkModeToggle.init()
    DoxygenAwesomeParagraphLink.init()
    DoxygenAwesomeInteractiveToc.init()
    DoxygenAwesomeTabs.init()
</script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only-darkmode-toggle.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- https://tholman.com/github-corners/ -->
<a href="https://github.com/jothepro/doxygen-awesome-css" class="github-corner" title="View source on GitHub" target="_blank" rel="noopener noreferrer">
    <svg viewBox="0 0 250 250" width="40" height="40" style="position: absolute; top: 0; border: 0; right: 0; z-index: 99;" aria-hidden="true">
    <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">rob
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part --><!-- Generated by Doxygen 1.10.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('md__2tmp_2github__repos__arch__doc__gen_2yshishenya_2rob_2backend_2auth_2auth.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">auth</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Давайте дополним руководство, добавив недостающую информацию из предоставленных вами фрагментов кода и моделей.</p>
<hr  />
<h1><a class="anchor" id="autotoc_md1"></a>
Руководство по использованию API</h1>
<h2><a class="anchor" id="autotoc_md2"></a>
Введение</h2>
<p>Данное руководство предназначено для фронтенд- и бэкенд-разработчиков. Оно описывает основные маршруты для взаимодействия с бэкендом через API, а также детали авторизации и управления пользователями. Все запросы к API должны быть авторизованы с использованием токена доступа.</p>
<hr  />
<h2><a class="anchor" id="autotoc_md4"></a>
Аутентификация</h2>
<h3><a class="anchor" id="autotoc_md5"></a>
Получение токенов</h3>
<p>Для выполнения аутентификации и получения токенов доступа и обновления, отправьте POST-запрос на <code>/login</code>, указав имя пользователя и пароль в теле запроса в формате <code>application/x-www-form-urlencoded</code>.</p>
<div class="fragment"><div class="line">curl -X POST https://dev.rob.pro-4.ru/login \</div>
<div class="line"> -H &quot;Content-Type: application/json&quot; \</div>
<div class="line"> -d &#39;{&quot;username&quot;:&quot;user&quot;, &quot;password&quot;:&quot;password&quot;}&#39;</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md6"></a>
Пример успешного ответа</h3>
<p>В ответе вы получите два токена: <code>access_token</code> для доступа к защищенным маршрутам и <code>refresh_token</code> для обновления <code>access_token</code> по его истечении.</p>
<div class="fragment"><div class="line">{</div>
<div class="line">  &quot;access_token&quot;: &quot;25ac806aba456abac04dade950f754592f3763ff1a3fa564&quot;,</div>
<div class="line">  &quot;expires_in&quot;: 3600,</div>
<div class="line">  &quot;expires_at&quot;: &quot;2024-05-18T09:39:27.487986&quot;,</div>
<div class="line">  &quot;refresh_token&quot;: &quot;14c23f5e6c412cdadfc3e71fbff240d8d7bf7edd582e6153&quot;,</div>
<div class="line">  &quot;refresh_expires_in&quot;: 2592000,</div>
<div class="line">  &quot;refresh_token_expires_at&quot;: &quot;2024-06-17T08:39:27.487995&quot;,</div>
<div class="line">  &quot;is_admin&quot;: true</div>
<div class="line">}</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md7"></a>
Описание полей ответа</h3>
<ul>
<li><b>access_token</b>: Токен доступа, который используется для аутентификации пользователя в системе.</li>
<li><b>expires_in</b>: Время жизни токена доступа в секундах (3600 секунд = 1 час).</li>
<li><b>expires_at</b>: Точная дата и время истечения токена доступа в формате ISO 8601.</li>
<li><b>refresh_token</b>: Токен для обновления доступа, который можно использовать для получения нового токена доступа после истечения текущего.</li>
<li><b>refresh_expires_in</b>: Время жизни токена для обновления в секундах (2592000 секунд = 30 дней).</li>
<li><b>refresh_token_expires_at</b>: Точная дата и время истечения токена обновления в формате ISO 8601.</li>
<li><b>is_admin</b>: Флаг, указывающий, является ли пользователь администратором. <code>true</code>, если пользователь имеет права администратора.</li>
</ul>
<hr  />
<h2><a class="anchor" id="autotoc_md9"></a>
Использование access_token</h2>
<p>Для доступа к защищенным маршрутам включайте полученный <code>access_token</code> в запросы.</p>
<h3><a class="anchor" id="autotoc_md10"></a>
Пример подключения к WebSocket</h3>
<div class="fragment"><div class="line">const listenToSockEvents = () =&gt; {</div>
<div class="line">  const { protocol, host, pathname } = window.location;</div>
<div class="line">  const token = &quot;токен&quot;; // вставьте свой токен</div>
<div class="line">  const ws_uri = `${</div>
<div class="line">    protocol === &quot;https:&quot; ? &quot;wss:&quot; : &quot;ws:&quot;</div>
<div class="line">  }//${host}${pathname}ws?token=${encodeURIComponent(token)}`;</div>
<div class="line">  const converter = new showdown.Converter();</div>
<div class="line">  const socket = new WebSocket(ws_uri);</div>
<div class="line"> </div>
<div class="line">  socket.onmessage = (event) =&gt; {</div>
<div class="line">    const data = JSON.parse(event.data);</div>
<div class="line">    if (data.type === &quot;logs&quot;) {</div>
<div class="line">      addAgentResponse(data);</div>
<div class="line">    } else if (data.type === &quot;report&quot;) {</div>
<div class="line">      writeReport(data, converter);</div>
<div class="line">    } else if (data.type === &quot;path&quot;) {</div>
<div class="line">      updateState(&quot;finished&quot;);</div>
<div class="line">      updateDownloadLink(data);</div>
<div class="line">    }</div>
<div class="line">  };</div>
<div class="line">};</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md11"></a>
Пример использования WebSocket на Python</h3>
<div class="fragment"><div class="line"><span class="keyword">import</span> asyncio</div>
<div class="line"><span class="keyword">import</span> websockets</div>
<div class="line"><span class="keyword">import</span> json</div>
<div class="line"> </div>
<div class="line"><span class="keyword">async def </span>connect():</div>
<div class="line">    uri = <span class="stringliteral">&quot;ws://localhost:8000/ws?token=&lt;access_token&gt;&quot;</span></div>
<div class="line">    <span class="keyword">async</span> <span class="keyword">with</span> websockets.connect(uri) <span class="keyword">as</span> websocket:</div>
<div class="line">        await websocket.send(json.dumps({</div>
<div class="line">            <span class="stringliteral">&quot;task&quot;</span>: <span class="stringliteral">&quot;Example task&quot;</span>,</div>
<div class="line">            <span class="stringliteral">&quot;report_type&quot;</span>: <span class="stringliteral">&quot;pdf&quot;</span></div>
<div class="line">        }))</div>
<div class="line">        response = await websocket.recv()</div>
<div class="line">        print(response)</div>
<div class="line"> </div>
<div class="line">asyncio.get_event_loop().run_until_complete(connect())</div>
</div><!-- fragment --><hr  />
<h2><a class="anchor" id="autotoc_md13"></a>
Обновление токена доступа</h2>
<h3><a class="anchor" id="autotoc_md14"></a>
Использование refresh_token</h3>
<p>Когда срок действия <code>access_token</code> подходит к концу, вы можете использовать <code>refresh_token</code> для получения нового токена доступа. Для этого отправьте POST-запрос на <code>/api/refresh</code>, передав <code>refresh_token</code> в теле запроса.</p>
<div class="fragment"><div class="line">curl -X POST https://dev.volter.pro-4.ru/api/refresh \</div>
<div class="line"> -H &quot;Content-Type: application/json&quot; \</div>
<div class="line"> -d &#39;{&quot;refresh_token&quot;:&quot;&lt;ваш_refresh_token&gt;&quot;}&#39;</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md15"></a>
Пример успешного ответа</h3>
<p>После успешного выполнения запроса на обновление токена доступа, вы получите JSON с новым <code>access_token</code> и <code>refresh_token</code>.</p>
<div class="fragment"><div class="line">{</div>
<div class="line">  &quot;access_token&quot;: &quot;2dc01915898f60c9f378074e62b677285281c6338fdcb787&quot;,</div>
<div class="line">  &quot;expires_in&quot;: 3600,</div>
<div class="line">  &quot;expires_at&quot;: &quot;2024-05-18T09:49:04.334472&quot;,</div>
<div class="line">  &quot;refresh_token&quot;: &quot;cb96f0025f869215a047f354c95b8145c17949be16b9391c&quot;,</div>
<div class="line">  &quot;refresh_expires_in&quot;: 2592000,</div>
<div class="line">  &quot;refresh_expires_at&quot;: &quot;2024-06-17T08:49:04.334500&quot;</div>
<div class="line">}</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md16"></a>
Описание ошибок</h3>
<p><b>1. 401 Unauthorized:</b> Ошибка аутентификации. Возникает, если предоставленный токен недействителен или истек.</p>
<p><b>Причины</b>:</p>
<ul>
<li>Неверный <code>access_token</code> или <code>refresh_token</code>.</li>
<li>Токен истек.</li>
</ul>
<p><b>Пример ответа:</b></p>
<div class="fragment"><div class="line">{</div>
<div class="line">  &quot;detail&quot;: &quot;Could not validate credentials&quot;</div>
<div class="line">}</div>
</div><!-- fragment --><hr  />
<h2><a class="anchor" id="autotoc_md18"></a>
Описание системы авторизации</h2>
<h3><a class="anchor" id="autotoc_md19"></a>
Общая структура</h3>
<p>Система авторизации состоит из нескольких модулей, которые взаимодействуют друг с другом для обеспечения безопасности и управления доступом пользователей. Основные компоненты включают:</p>
<ol type="1">
<li><b><a class="el" href="auth_8py.html">auth.py</a></b> - Основной модуль, содержащий маршруты и логику авторизации.</li>
<li><b><a class="el" href="redis__token__storage_8py.html">redis_token_storage.py</a></b> - Реализация хранилища токенов на основе Redis.</li>
<li><b><a class="el" href="token__storage_8py.html">token_storage.py</a></b> - Абстрактный класс для хранилища токенов.</li>
<li><b><a class="el" href="db_8py.html">db.py</a></b> - Модуль для работы с базой данных.</li>
<li><b><a class="el" href="server_8py.html">server.py</a></b> - Основной серверный модуль, который включает маршруты и инициализирует приложение.</li>
</ol>
<h3><a class="anchor" id="autotoc_md20"></a>
Модуль auth.py</h3>
<p>Этот модуль содержит маршруты и логику для авторизации пользователей. Основные функции включают:</p>
<ul>
<li>**/login**: Позволяет пользователю войти в систему, используя имя пользователя и пароль. Возвращает токены доступа и обновления.</li>
<li>**/logout**: Позволяет пользователю выйти из системы, используя refresh_token. Очищает токены доступа и обновления.</li>
<li>**/refresh**: Обновляет токен доступа, используя токен обновления.</li>
<li>**/users/create**: Создает нового пользователя (только для администраторов).</li>
<li>**/users/delete**: Удаляет пользователя по идентификатору (только для администраторов).</li>
<li>**/users/password**: Изменяет пароль пользователя (только для администраторов).</li>
<li>**/users/modify**: Изменяет данные пользователя (только для администраторов).</li>
<li>**/users**: Возвращает список всех пользователей (только для администраторов).</li>
</ul>
<h3><a class="anchor" id="autotoc_md21"></a>
Модели Pydantic</h3>
<p>Для валидации данных используются Pydantic-модели.</p>
<div class="fragment"><div class="line"><span class="keyword">class </span>LoginRequest(BaseModel):</div>
<div class="line">    username: str = Field(..., description=<span class="stringliteral">&quot;Имя пользователя для входа в систему. Должно быть уникальным и не повторяться с другими пользователями.&quot;</span>)</div>
<div class="line">    password: str = Field(..., description=<span class="stringliteral">&quot;Пароль пользователя. Должен быть надежным и содержать минимум 6 символов для обеспечения безопасности.&quot;</span>)</div>
<div class="line"> </div>
<div class="line"><span class="keyword">class </span>LoginResponse(BaseModel):</div>
<div class="line">    access_token: str = Field(..., description=<span class="stringliteral">&quot;Токен доступа, который используется для аутентификации пользователя в системе.&quot;</span>)</div>
<div class="line">    expires_in: int = Field(..., description=<span class="stringliteral">&quot;Время жизни токена доступа в секундах, после которого токен становится недействительным.&quot;</span>)</div>
<div class="line">    expires_at: str = Field(..., description=<span class="stringliteral">&quot;Точная дата и время истечения токена доступа в формате ISO 8601.&quot;</span>)</div>
<div class="line">    refresh_token: str = Field(..., description=<span class="stringliteral">&quot;Токен для обновления доступа, который можно использовать для получения нового токена доступа после истечения текущего.&quot;</span>)</div>
<div class="line">    refresh_expires_in: int = Field(..., description=<span class="stringliteral">&quot;Время жизни токена для обновления в секундах, после которого токен становится недействительным.&quot;</span>)</div>
<div class="line">    refresh_token_expires_at: str = Field(..., description=<span class="stringliteral">&quot;Точная дата и время истечения токена обновления в формате ISO 8601.&quot;</span>)</div>
<div class="line">    is_admin: bool = Field(..., description=<span class="stringliteral">&quot;Флаг, указывающий, является ли пользователь администратором. True, если пользователь имеет права администратора.&quot;</span>)</div>
<div class="line"> </div>
<div class="line"><span class="keyword">class </span>RefreshRequest(BaseModel):</div>
<div class="line">    refresh_token: str = Field(..., description=<span class="stringliteral">&quot;Токен обновления, который нужно использовать для получения нового токена доступа.&quot;</span>)</div>
<div class="line"> </div>
<div class="line"><span class="keyword">class </span>RefreshResponse(BaseModel):</div>
<div class="line">    access_token: str = Field(..., description=<span class="stringliteral">&quot;Новый токен доступа, выданный пользователю.&quot;</span>)</div>
<div class="line">    expires_in: int = Field(..., description=<span class="stringliteral">&quot;Время жизни нового токена доступа в секундах.&quot;</span>)</div>
<div class="line">    expires_at: str = Field(..., description=<span class="stringliteral">&quot;Время истечения нового токена доступа в формате ISO 8601.&quot;</span>)</div>
<div class="line">    refresh_token: str = Field(..., description=<span class="stringliteral">&quot;Новый токен обновления, выданный пользователю.&quot;</span>)</div>
<div class="line">    refresh_expires_in: int = Field(..., description=<span class="stringliteral">&quot;Время жизни нового токена обновления в секундах.&quot;</span>)</div>
<div class="line">    refresh_expires_at: str = Field(..., description=<span class="stringliteral">&quot;Время истечения нового токена обновления в формате ISO 8601.&quot;</span>)</div>
<div class="line"> </div>
<div class="line"><span class="keyword">class </span>UserCreateRequest(BaseModel):</div>
<div class="line">    username: constr(min_length=3, max_length=50) = Field(..., description=<span class="stringliteral">&quot;Имя пользователя. Должно быть уникальным и содержать от 3 до 50 символов.&quot;</span>)</div>
<div class="line">    email: EmailStr = Field(..., description=<span class="stringliteral">&quot;Электронная почта пользователя. Должна быть действительной и уникальной.&quot;</span>)</div>
<div class="line">    password: constr(min_length=6, max_length=50) = Field(..., description=<span class="stringliteral">&quot;Пароль пользователя. Должен быть надежным и содержать от 6 до 50 символов.&quot;</span>)</div>
<div class="line">    is_admin: bool = Field(..., description=<span class="stringliteral">&quot;Является ли пользователь администратором. True, если пользователь имеет права администратора.&quot;</span>)</div>
<div class="line"> </div>
<div class="line"><span class="keyword">class </span>UserResponse(BaseModel):</div>
<div class="line">    id: int = Field(..., description=<span class="stringliteral">&quot;Уникальный идентификатор пользователя в системе.&quot;</span>)</div>
<div class="line">    username: str = Field(..., description=<span class="stringliteral">&quot;Имя пользователя.&quot;</span>)</div>
<div class="line">    email: str = Field(..., description=<span class="stringliteral">&quot;Электронная почта пользователя.&quot;</span>)</div>
<div class="line">    is_admin: bool = Field(..., description=<span class="stringliteral">&quot;Признак того, является ли пользователь администратором.&quot;</span>)</div>
<div class="line"> </div>
<div class="line"><span class="keyword">class </span>PasswordChangeRequest(BaseModel):</div>
<div class="line">    user_id: int = Field(..., description=<span class="stringliteral">&quot;Идентификатор пользователя, для которого нужно изменить пароль.&quot;</span>)</div>
<div class="line">    new_password: str = Field(..., description=<span class="stringliteral">&quot;Новый пароль пользователя. Должен быть надежным и содержать минимум 6 символов.&quot;</span>)</div>
<div class="line"> </div>
<div class="line"><span class="keyword">class </span>PasswordChangeResponse(BaseModel):</div>
<div class="line">    user_id: int = Field(..., description=<span class="stringliteral">&quot;Идентификатор пользователя, для которого был изменен пароль.&quot;</span>)</div>
<div class="line">    message: str = Field(..., description=<span class="stringliteral">&quot;Сообщение об успешной смене пароля.&quot;</span>)</div>
<div class="line"> </div>
<div class="line"><span class="keyword">class </span>DeleteUserRequest(BaseModel):</div>
<div class="line">    user_id: int = Field(..., description=<span class="stringliteral">&quot;Идентификатор пользователя, которого нужно удалить.&quot;</span>)</div>
<div class="line"> </div>
<div class="line"><span class="keyword">class </span>DeleteUserResponse(BaseModel):</div>
<div class="line">    message: str = Field(..., description=<span class="stringliteral">&quot;Сообщение об успешном удалении пользователя.&quot;</span>)</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md22"></a>
Функции для работы с токенами</h3>
<p>Использование функций для создания и проверки токенов:</p>
<div class="fragment"><div class="line"><span class="keyword">async def </span>create_tokens(user_id):</div>
<div class="line">    access_token = binascii.hexlify(os.urandom(24)).decode()</div>
<div class="line">    access_token_expires_in = 3600  <span class="comment"># 1 час в секундах</span></div>
<div class="line">    access_token_expires_at = datetime.utcnow() + timedelta(seconds=access_token_expires_in)</div>
<div class="line">    refresh_token = binascii.hexlify(os.urandom(24)).decode()</div>
<div class="line">    refresh_token_expires_in = 2592000  <span class="comment"># 30 дней в секундах</span></div>
<div class="line">    refresh_token_expires_at = datetime.utcnow() + timedelta(seconds=refresh_token_expires_in)</div>
<div class="line"> </div>
<div class="line">    token_storage.store_token(access_token, user_id, access_token_expires_in)</div>
<div class="line">    token_storage.store_refresh_token(refresh_token, user_id, refresh_token_expires_in)</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> {</div>
<div class="line">        <span class="stringliteral">&#39;token&#39;</span>: access_token,</div>
<div class="line">        <span class="stringliteral">&#39;expires_in&#39;</span>: access_token_expires_in,</div>
<div class="line">        <span class="stringliteral">&#39;expires_at&#39;</span>: access_token_expires_at.isoformat()</div>
<div class="line">    }, {</div>
<div class="line">        <span class="stringliteral">&#39;token&#39;</span>: refresh_token,</div>
<div class="line">        <span class="stringliteral">&#39;expires_in&#39;</span>: refresh_token_expires_in,</div>
<div class="line">        <span class="stringliteral">&#39;expires_at&#39;</span>: refresh_token_expires_at.isoformat()</div>
<div class="line">    }</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md23"></a>
API Маршруты</h3>
<h4><a class="anchor" id="autotoc_md24"></a>
Авторизация пользователя</h4>
<div class="fragment"><div class="line">POST /login</div>
<div class="line">Content-Type: application/x-www-form-urlencoded</div>
<div class="line"> </div>
<div class="line">username=&lt;username&gt;&amp;password=&lt;password&gt;</div>
</div><!-- fragment --><h4><a class="anchor" id="autotoc_md25"></a>
Обновление токена доступа</h4>
<div class="fragment"><div class="line">POST /refresh</div>
<div class="line">Content-Type: application/json</div>
<div class="line"> </div>
<div class="line">{</div>
<div class="line">  &quot;refresh_token&quot;: &quot;&lt;refresh_token&gt;&quot;</div>
<div class="line">}</div>
</div><!-- fragment --><h4><a class="anchor" id="autotoc_md26"></a>
Создание нового пользователя (только для администраторов)</h4>
<div class="fragment"><div class="line">POST /users/create</div>
<div class="line">Content-Type: application/json</div>
<div class="line">Authorization: Bearer &lt;admin_access_token&gt;</div>
<div class="line"> </div>
<div class="line">{</div>
<div class="line">  &quot;username&quot;: &quot;&lt;username&gt;&quot;,</div>
<div class="line">  &quot;email&quot;: &quot;&lt;email&gt;&quot;,</div>
<div class="line">  &quot;password&quot;: &quot;&lt;password&gt;&quot;,</div>
<div class="line">  &quot;is_admin&quot;: &lt;true|false&gt;</div>
<div class="line">}</div>
</div><!-- fragment --><h4><a class="anchor" id="autotoc_md27"></a>
Удаление пользователя (только для администраторов)</h4>
<div class="fragment"><div class="line">DELETE /users/delete</div>
<div class="line">Content-Type: application/json</div>
<div class="line">Authorization: Bearer &lt;admin_access_token&gt;</div>
<div class="line"> </div>
<div class="line">{</div>
<div class="line">  &quot;user_id&quot;: &lt;user_id&gt;</div>
<div class="line">}</div>
</div><!-- fragment --><h4><a class="anchor" id="autotoc_md28"></a>
Смена пароля пользователя (только для администраторов)</h4>
<div class="fragment"><div class="line">PUT /users/password</div>
<div class="line">Content-Type: application/json</div>
<div class="line">Authorization: Bearer &lt;admin_access_token&gt;</div>
<div class="line"> </div>
<div class="line">{</div>
<div class="line">  &quot;user_id&quot;: &lt;user_id&gt;,</div>
<div class="line">  &quot;new_password&quot;: &quot;&lt;new_password&gt;&quot;</div>
<div class="line">}</div>
</div><!-- fragment --><h4><a class="anchor" id="autotoc_md29"></a>
Изменение данных пользователя (только для администраторов)</h4>
<div class="fragment"><div class="line">PUT /users/modify</div>
<div class="line">Content-Type: application/json</div>
<div class="line">Authorization: Bearer &lt;admin_access_token&gt;</div>
<div class="line"> </div>
<div class="line">{</div>
<div class="line">  &quot;user_id&quot;: &lt;user_id&gt;,</div>
<div class="line">  &quot;username&quot;: &quot;&lt;new_username&gt;&quot;,</div>
<div class="line">  &quot;email&quot;: &quot;&lt;new_email&gt;&quot;,</div>
<div class="line">  &quot;password&quot;: &quot;&lt;new_password&gt;&quot;,</div>
<div class="line">  &quot;is_admin&quot;: &lt;true|false&gt;</div>
<div class="line">}</div>
</div><!-- fragment --><h4><a class="anchor" id="autotoc_md30"></a>
Получение списка пользователей (только для администраторов)</h4>
<div class="fragment"><div class="line">GET /users</div>
<div class="line">Authorization: Bearer &lt;admin_access_token&gt;</div>
</div><!-- fragment --><hr  />
<h2><a class="anchor" id="autotoc_md32"></a>
Инициализация приложения</h2>
<h3><a class="anchor" id="autotoc_md33"></a>
Модуль server.py</h3>
<p>Инициализация приложения происходит следующим образом:</p>
<div class="fragment"><div class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</div>
<div class="line"><span class="keyword">from</span> backend.auth.auth <span class="keyword">import</span> init_app</div>
<div class="line"> </div>
<div class="line">app = FastAPI()</div>
<div class="line">init_app(app)</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md34"></a>
Инструкция по реализации логаута</h3>
<ol type="1">
<li>Отправка запроса на логаут Когда пользователь нажимает кнопку "Выйти" (Logout), фронтенд должен отправить POST-запрос на эндпоинт /logout. В запросе необходимо передать access_token в заголовке авторизации. Пример запроса с использованием curl:</li>
</ol>
<div class="fragment"><div class="line">curl -X POST https://dev.rob.pro-4.ru/logout \</div>
<div class="line">-H &quot;accept: application/json&quot; \</div>
<div class="line">-H &quot;Authorization: Bearer &lt;access_token&gt;&quot; \</div>
<div class="line">-d &#39;&#39;</div>
</div><!-- fragment --><ol type="1">
<li>Очистка токенов После успешного ответа от сервера, необходимо выполнить следующие действия на фронтенде:</li>
</ol>
<ol type="1">
<li>Удалить access_token и refresh_token из локального хранилища (например, localStorage).</li>
</ol>
<ol type="1">
<li>Перенаправить пользователя на страницу входа или главную страницу. Пример кода на JavaScript:</li>
</ol>
<div class="fragment"><div class="line">fetch(&quot;https://dev.rob.pro-4.ru/logout&quot;, {</div>
<div class="line">  method: &quot;POST&quot;,</div>
<div class="line">  headers: {</div>
<div class="line">    accept: &quot;application/json&quot;,</div>
<div class="line">    Authorization: `Bearer ${localStorage.getItem(&quot;access_token&quot;)}`,</div>
<div class="line">  },</div>
<div class="line">})</div>
<div class="line">  .then((response) =&gt; {</div>
<div class="line">    if (response.ok) {</div>
<div class="line">      // Удаляем токены из локального хранилища</div>
<div class="line">      localStorage.removeItem(&quot;access_token&quot;);</div>
<div class="line">      localStorage.removeItem(&quot;refresh_token&quot;);</div>
<div class="line">      // Перенаправляем пользователя на страницу входа</div>
<div class="line">      window.location.href = &quot;/login&quot;;</div>
<div class="line">    } else {</div>
<div class="line">      // Обработка ошибок</div>
<div class="line">      console.error(&quot;Ошибка при логауте:&quot;, response.statusText);</div>
<div class="line">    }</div>
<div class="line">  })</div>
<div class="line">  .catch((error) =&gt; {</div>
<div class="line">    console.error(&quot;Ошибка сети:&quot;, error);</div>
<div class="line">  });</div>
</div><!-- fragment --><ol type="1">
<li>Обработка ошибок Если сервер вернул ошибку (например, токен недействителен или истек), необходимо запросить новый токен с использованием refresh_token и повторить логаут. Пример кода на JavaScript:</li>
</ol>
<div class="fragment"><div class="line">function logout() {</div>
<div class="line">  fetch(&quot;https://dev.rob.pro-4.ru/logout&quot;, {</div>
<div class="line">    method: &quot;POST&quot;,</div>
<div class="line">    headers: {</div>
<div class="line">      accept: &quot;application/json&quot;,</div>
<div class="line">      Authorization: `Bearer ${localStorage.getItem(&quot;access_token&quot;)}`,</div>
<div class="line">    },</div>
<div class="line">  })</div>
<div class="line">    .then((response) =&gt; {</div>
<div class="line">      if (response.ok) {</div>
<div class="line">        localStorage.removeItem(&quot;access_token&quot;);</div>
<div class="line">        localStorage.removeItem(&quot;refresh_token&quot;);</div>
<div class="line">        window.location.href = &quot;/login&quot;;</div>
<div class="line">      } else if (response.status === 401) {</div>
<div class="line">        // Токен недействителен или истек, обновляем токен</div>
<div class="line">        refreshTokenAndRetryLogout();</div>
<div class="line">      } else {</div>
<div class="line">        console.error(&quot;Ошибка при логауте:&quot;, response.statusText);</div>
<div class="line">      }</div>
<div class="line">    })</div>
<div class="line">    .catch((error) =&gt; {</div>
<div class="line">      console.error(&quot;Ошибка сети:&quot;, error);</div>
<div class="line">    });</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">function refreshTokenAndRetryLogout() {</div>
<div class="line">  fetch(&quot;https://dev.rob.pro-4.ru/api/refresh&quot;, {</div>
<div class="line">    method: &quot;POST&quot;,</div>
<div class="line">    headers: {</div>
<div class="line">      &quot;Content-Type&quot;: &quot;application/json&quot;,</div>
<div class="line">    },</div>
<div class="line">    body: JSON.stringify({</div>
<div class="line">      refresh_token: localStorage.getItem(&quot;refresh_token&quot;),</div>
<div class="line">    }),</div>
<div class="line">  })</div>
<div class="line">    .then((response) =&gt; response.json())</div>
<div class="line">    .then((data) =&gt; {</div>
<div class="line">      localStorage.setItem(&quot;access_token&quot;, data.access_token);</div>
<div class="line">      localStorage.setItem(&quot;refresh_token&quot;, data.refresh_token);</div>
<div class="line">      // Повторяем логаут</div>
<div class="line">      logout();</div>
<div class="line">    })</div>
<div class="line">    .catch((error) =&gt; {</div>
<div class="line">      console.error(&quot;Ошибка при обновлении токена:&quot;, error);</div>
<div class="line">    });</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">// Вызов функции логаута</div>
<div class="line">logout();</div>
</div><!-- fragment --><hr  />
<h2><a class="anchor" id="autotoc_md36"></a>
Заключение</h2>
<p>Эта система авторизации обеспечивает безопасное управление пользователями и токенами, используя FastAPI, SQLAlchemy и Redis. Для добавления новых функций или изменения существующих, следуйте структуре и принципам, описанным выше.</p>
<p><img src="auth_man.png" alt="Еще одна иструкция" class="inline"/> </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.10.0-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://penify.dev/"><img class="footer" src="https://www.penify.dev/_next/static/media/snorkell-dark-logo.9fa414f5.svg" width="104" height="31" alt="doxygen"/></a> </li>
  </ul>
</div>
</body>
</html>
